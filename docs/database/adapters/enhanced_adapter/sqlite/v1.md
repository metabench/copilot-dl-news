# enhanced_adapter • SQLite v1

## Purpose
`EnhancedDatabaseAdapter` decorates a `NewsDatabase` instance with feature-specific modules for queues, planner knowledge, and coverage analytics. It exists to centralize schema management for optional tables and provide consistent logging/maintenance helpers.

## Initialization Flow
1. Caller creates a `NewsDatabase` (or compatible wrapper) and passes it to the adapter constructor.
2. The adapter unwraps the raw `better-sqlite3` handle (handles nested `.db` properties).
3. Each sub-module (`QueueDatabase`, `PlannerDatabase`, `CoverageDatabase`) initializes its schema and prepared statements. Failures surface as explicit errors (e.g., `QueueDatabase initialization failed: ...`).
4. A success message is logged: `Enhanced database adapter initialized with queue, planner, and coverage modules`.

## Configuration & Feature Toggles
- **No separate options object:** the adapter reads feature enablement from configuration layers (e.g., `config/priority-config.json`) that call into the underlying modules.
- **Optional usage:** If downstream code catches the initialization error, it can continue operating with just the base `NewsDatabase`.
- **Maintenance hooks:** `performMaintenance({ cleanupKnowledge, cleanupTelemetry, cleanupClusters })` executes cleanup tasks across modules and returns a summary payload.

## Module APIs
### QueueDatabase
- `logEnhancedQueueEvent({...})` – Records queue telemetry, resolving URL IDs via internal helper.
- `createOrUpdateProblemCluster({...})`, `getProblemCluster(id)`, `getActiveClusters(jobId)` – Manage clustering analytics.
- `recordGapPrediction(...)`, `validateGapPrediction(...)` – Manage gap prediction lifecycle.
- `logConfigChange(...)` – Audit priority config changes.

### PlannerDatabase
- `recordPattern`, `getPatternsByDomain`, `updatePatternSuccess/Failure` – Pattern lifecycle.
- `recordHubValidation`, `getValidatedHubs`, `getExpiredHubs` – Hub validation cache.
- `recordReuseEvent`, `storeCrossCrawlKnowledge`, `getCrossCrawlKnowledge` – Knowledge reuse analytics.
- `getPatternAnalytics`, `getKnowledgeReuseStats` – Reporting helpers.

### CoverageDatabase
- `recordCoverageSnapshot`, `getSnapshotTrend`, `getDiscoveryStats` – Coverage telemetry.
- `recordHubDiscovery`, `getRecentDiscoveries` – Hub discovery tracking.
- `recordGap`, `resolveGap`, `getActiveGaps` – Coverage gap management.
- `recordMilestoneAchievement`, `getRecentMilestones` – Milestone capture.
- `insertMetric`, `getMetricTimeSeries`, `getLatestMetrics` – Dashboard metrics support.

## Transactions & Error Handling
- Each module uses prepared statements per operation; errors are caught and logged to `console.error` with module prefixes (`[QueueDatabase]`, `[PlannerDatabase]`, `[CoverageDatabase]`).
- Failures return neutral values (`null`, `[]`) so callers can decide whether to retry.
- `EnhancedDatabaseAdapter.performMaintenance` wraps operations in try/catch and annotates the returned summary with `results.error` on failure.

## Health Monitoring
- `healthCheck()` executes a `SELECT 1` probe and reports:
  - `features.queue|planner|coverage` flagging module availability.
  - Table existence map (verifies schema upgrades).
  - Query latency (single `SELECT 1`).

## Example Usage
```javascript
const { createSQLiteDatabase } = require('../../src/db/sqlite/v1');
const { EnhancedDatabaseAdapter } = require('../../src/db/EnhancedDatabaseAdapter');

const core = createSQLiteDatabase({ dbPath: 'data/news.db' });
const enhanced = new EnhancedDatabaseAdapter(core);

enhanced.queue.logEnhancedQueueEvent({
  jobId: 'crawl-2025-11-01',
  ts: new Date().toISOString(),
  action: 'enqueue',
  url: 'https://example.com/story/123',
  depth: 1,
  queueSize: 42
});

enhanced.planner.recordHubValidation({
  domain: 'example.com',
  hubUrl: 'https://example.com/world',
  hubType: 'country-hub',
  validationStatus: 'valid',
  classificationConfidence: 0.92,
  contentIndicators: { hasNav: true }
});
```

## Performance Considerations
- Enhanced tables are mostly empty today; initial bulk population can happen offline.
- Queue event logging runs synchronously inside the crawler—keep payloads minimal to avoid blocking fetch threads.
- Planner and coverage methods serialize JSON metadata; prefer concise structures to limit string size.

## Maintenance Workflow
1. Run `healthCheck()` during startup; log warnings (but do not crash) if optional features are unavailable.
2. Schedule `performMaintenance()` (e.g., daily) to clean telemetry, expired knowledge, and stale clusters.
3. Monitor row counts in `news_db_stats.json` to confirm features are populating data as expected.

## Integration Notes
- Enhanced modules rely on the same URL normalization helpers as the base adapter. Ensure `urlHelpers.ensureUrlId` stays in sync when migrations adjust URL schema.
- When running migrations that touch enhanced tables, update both the schema snapshot and the adapter docs to reflect new columns/indexes.
