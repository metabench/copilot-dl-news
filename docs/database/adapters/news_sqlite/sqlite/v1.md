# news_sqlite • SQLite v1 Adapter

## Purpose
`v1` is the current production implementation of `NewsDatabase`. It wraps `better-sqlite3` connections with schema initialization, statement caching, and helper modules for articles, gazetteer operations, and crawler telemetry.

## Connection & Configuration
| Option | Default | Description |
| --- | --- | --- |
| `dbPath` | `data/news.db` | File opened by `createSQLiteDatabase` / `ensureDatabase`. |
| `readonly` | `false` | Passed through to `openDatabase`; skips schema bootstrap when `true`. |
| `fileMustExist` | `false` | Set to `true` for read-only replicas (tasks, analyzers). |
| `verbose` | `false` | Enables schema bootstrap logs. |
| `logger` | `console` | Target for schema bootstrap + seeding logs. |
| `skipSchema` | `false` | Bypass initialization (used by migration tooling after manual DDL). |

### Pragmas
Applied on every connection (`src/db/sqlite/v1/connection.js`):
- `journal_mode = WAL`
- `foreign_keys = ON`
- `busy_timeout = 5000`
- `synchronous = NORMAL`

These settings balance durability with crawler throughput. Do not override without coordinating with the ingestion team.

## Module Breakdown
| Module | Responsibility |
| --- | --- |
| `SchemaInitializer` | Applies full schema (tables, indexes, triggers) when fingerprint mismatch is detected. |
| `schemaMetadata` | Stores and validates the current schema fingerprint; enables fast-path startup. |
| `StatementManager` | Prepares and memoizes frequently used statements (URL lookups, inserts, telemetry). |
| `ArticleOperations` | High-level API for article upsert, fetch insertion, and alias management. |
| `urlHelpers` | Shared URL ID resolver that deduplicates canonical rows. |
| `seeders` / `seed-utils` | Seeds crawl types and optional bootstrap datasets. |

## Query Interface
`NewsDatabase` exposes a rich set of methods. The most frequently used ones are:
- `upsertArticle(article, options)` – Main ingestion path for normalized article payloads.
- `insertFetch(fetchRow)` – Writes an HTTP response + payload metadata.
- `getArticleByUrl(url)` / `getArticleByUrlOrCanonical(url)` – Lookup with optional access logging.
- `insertLink({ src_url, dst_url, ... })` – Inserts graph edges, resolving URL IDs on the fly.
- `getFetchesByUrl(url, limit)` – Fetch history with join to content/analysis tables.
- `recordUrlAlias({ url, aliasUrl, ... })` – Adds alias mappings with metadata.

All write helpers wrap their logic with `_ensureUrlId` (`StatementManager` + `urlHelpers`), ensuring URL normalization is consistent with the broader migration effort.

## Transactions & Concurrency
- `better-sqlite3` provides synchronous transactions via `db.transaction`. Use it for multi-step updates (e.g., migrating rows between tables).
- WAL mode allows concurrent readers; writers still serialize. Keep transactions short and avoid long-running read locks when queue processing is active.
- For batch imports, stream through `insertFetch`/`upsertArticle` in chunks (<500 rows) to prevent busy timeouts.

## Error Handling
- `createSQLiteDatabase` throws if `dbPath` is missing.
- `ensureDatabase` logs bootstrap failures but rethrows critical errors (schema mismatch, seed failures).
- Most high-level methods catch SQL exceptions, log with `[NewsDatabase]` prefix, and return safe defaults (e.g., `[]`, `0`, or `null`). Callers must check for `null` before assuming side effects occurred.

## Telemetry & Observability
- Wrap the raw database with `wrapWithTelemetry(db, { trackQueries: true })` to emit entries into `query_telemetry`.
- Each prepared statement registered via `StatementManager` carries a stable key, simplifying telemetry grouping.
- `createInstrumentedDb` combines telemetry with `BackgroundTaskManager` integration (used by the enhanced adapter).

## Usage Examples
```javascript
const { createSQLiteDatabase, wrapWithTelemetry } = require('../../src/db/sqlite/v1');

// Open database with schema check
const newsDb = createSQLiteDatabase({ dbPath: 'data/news.db' });

// Record a new URL alias
newsDb.recordUrlAlias({
  url: 'https://example.com/story/123',
  aliasUrl: 'https://m.example.com/story/123',
  classification: 'mobile-redirect',
  reason: 'detected canonical redirect'
});

// Instrument long-running queries
const raw = newsDb.db; // better-sqlite3 handle
const instrumented = wrapWithTelemetry(raw, { trackQueries: true });
```

## Performance Guidance
- Index coverage is extensive; favour the prepared statements in `StatementManager` to avoid missing where clause hints.
- Use parameterized statements (`db.prepare(...).run(params)`)—`better-sqlite3` caches the bytecode and avoids SQL injection.
- `links` and `queue_events` are the largest tables. Filter by `job_id`, `url_id`, or time ranges to keep scans bounded.

## Testing Notes
- `src/db/sqlite/v1/__tests__` contains fixtures for article insertion, gazetteer seeding, and schema expectations.
- Use `test-utils.js#createTempDb()` to spin up an isolated database with the full schema for integration tests.

## Migration Considerations
- Schema updates should be published through `src/db/migrations/*.sql` and the Phase 0 migration toolkit.
- After applying migrations, regenerate `schema-definitions.js` (see header comment in that file) and refresh `docs/database/_artifacts/news_db_schema.sql`.
