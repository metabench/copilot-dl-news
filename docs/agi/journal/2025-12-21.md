# 2025-12-21 â€” Decision Tree access + SQL encapsulation guard

## Known facts
- Data Explorer (current UI) runs on port 4600 and exposes Decision Trees at `http://localhost:4600/decision-trees`.
- crawl-widget (Electron) now provides a progressive-disclosure Tools panel that can open Decision Trees / Data Explorer externally.
- The repo still contains many `db.prepare`/`db.exec` call sites outside `src/db/**`; strict â€œno SQL outside adaptersâ€ would be high-churn.

## Converged options

| Option | Impact | Effort | Risk | Domains |
| --- | --- | --- | --- | --- |
| 1) Strict layering: move all SQL under `src/db/**` | Clean architecture, simple rule | L | High churn, wide blast radius | Data, UI |
| 2) Pragmatic layering: forbid SQL in UI/Electron layers only | Protects UX layers immediately | Sâ€“M | Low | UI, Data |
| 3) Automated guard + allow-list | Stops backsliding; enables incremental migration | S | Low | Tooling |

Recommendation: do Option 2 + 3 first, then migrate the highest-value UI offenders (starting with `themeService`, then `geoImportServer`).

## Guard spec (MVP)
- FAIL if new direct SQL usage appears in:
  - `src/ui/**`
  - `crawl-widget/**`
- Signal patterns (text scan MVP): `db.prepare(`, `db.exec(`, `better-sqlite3` imports.
- Ignore: `src/db/**`, `tests/**`, `tools/**`, `scripts/**`, `checks/**`.
- Optional allow-list JSON: `{ path, reason }` entries for explicitly sanctioned exceptions.

## Handoffs
- Owner: ğŸ”§ CLI Tool Singularity â€” implement the guard as a small Node CLI + wire into checks/CI.
- Owner: ğŸ’¡UI SingularityğŸ’¡ â€” migrate `src/ui/server/services/themeService.js` DB access behind adapter/repository.
- Owner: ğŸ’¡UI SingularityğŸ’¡ â€” migrate `src/ui/server/geoImportServer.js` DB access behind adapter/repository, reusing the structure from `docs/sessions/2025-11-28-css-js-separation/`.
