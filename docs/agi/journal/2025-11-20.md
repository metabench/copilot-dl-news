# 2025-11-20 – js-scan Continuation Loop

## Sense
- Reviewed existing AI-native token flow (`tools/dev/js-scan.js`, `tests/tools/ai-native-cli.smoke.test.js`) and confirmed continuation handler was still a stub.
- Read `docs/sessions/2025-11-16-js-scan-terse-output` plus the TOOL catalog to align on selector-handoff progress from item #2.
- Inspected recent git history for js-scan/js-edit to avoid regressing other Tier 1 work.

## Plan
- Snapshot token payload gaps (missing match metadata, replay context, action handlers).
- Update js-scan so `--ai-mode` embeds match snapshots + scan context, then implement continuation handlers for analyze/trace/ripple.
- Refresh AI-native smoke tests + AGI docs (TOOLS, JS_SCAN_DEEP_DIVE, lessons) and log everything under `docs/sessions/2025-11-20-js-scan-continuation/`.

## Act
- Added helper utilities for token snapshots + replay, stored absolute file/selector metadata, and wired `handleContinuationToken` to execute analyze/trace/ripple actions.
- Restored `_ai_native_cli` metadata and ensured `continuation_tokens` map pairs with js-edit hints in JSON output.
- Extended smoke tests to cover compact token decoding plus trace/ripple continuations; recorded commands + results in session working notes.
- Implemented digest mismatch detection (warnings surfaced as `RESULTS_DIGEST_MISMATCH`) and bolstered smoke coverage for the stale-token path.

## Verify
- `npm run test:by-path tests/tools/ai-native-cli.smoke.test.js` (pass, 22 tests).
- Manual CLI spot-check (`node tools/dev/js-scan.js --dir tools/dev --search scanWorkspace --limit 1 --ai-mode --json` + replay via `--continuation -`).

## Next
- Consider exposing continuation tokens for other operations (e.g., `what-imports`, `what-calls`).
- Update js-edit to accept tokens directly (match snapshot → guard plan) once selector presets stabilize.

## Follow-up (Item #6 – Continuation Tokens Phase 2)
- **Sense (2025-11-21)**: Confirmed tokens currently emit only for `--search`; relationship operations (`what-imports`, `export-usage`) drop the importer/usage metadata on the floor, and js-edit still requires manual selector replay despite match snapshots containing `jsEditHint` payloads.
- **Plan**:
	- Extend `generateNextActions`/`generateTokens` so relationship queries can opt into `--ai-mode`, emitting importer/usage snapshots (file, specifier, line span, digest) plus action IDs (`importer:analyze:<idx>`, `usage:direct:<idx>`, etc.).
	- Teach `handleContinuationToken` to branch on these new action prefixes and hydrate RelationshipAnalyzer results before returning JSON (with digest warnings similar to search replay).
	- On the edit side, add a js-edit entry point (`--match-snapshot` or stdin token) that converts the captured snapshot/jsEditHint into a guard plan, so continuation output can feed directly into `--from-plan` without another locate run.
- **Act**: Pending – need to spec JSON payload shape plus test updates before handing off to a code-editing agent.
- **Verify**: Targeted smoke coverage in `tests/tools/ai-native-cli.smoke.test.js` (new describe blocks for `what-imports`/`export-usage`) and an integration test that pipes a continuation token into `js-edit --match-snapshot - --dry-run` once implemented.
- **Next**: Record the detailed plan in `docs/agi/tools/JS_SCAN_DEEP_DIVE.md` + `JS_EDIT_DEEP_DIVE.md`, update TOOLS catalog/backlog, then queue implementation work.
