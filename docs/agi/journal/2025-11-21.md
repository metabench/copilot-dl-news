# 2025-11-21 – Relationship Tokens Phase 2

## Sense
- Reviewed the 2025-11-20 continuation-token work plus the follow-up plan to extend coverage beyond search.
- Re-read `docs/agi/tools/JS_SCAN_DEEP_DIVE.md` and `tests/tools/ai-native-cli.smoke.test.js` to confirm current capabilities and uncover gaps.
- Inspected `tools/dev/js-scan.js` and `tools/dev/js-scan/operations/relationships.js` to understand importer/usage payloads.

## Plan
- Let `--what-imports` and `--export-usage` opt into `--ai-mode` output by emitting importer/usage snapshots with continuation tokens.
- Teach `handleContinuationToken` how to replay relationship queries, compare digests, and return structured importer/usage data.
- Expand the AI-native smoke suite to cover the new flows and document the behavior for downstream agents.

## Act
- Added reusable helpers (`createAiNativeEnvelope`, snapshot builders, relationship token generator, replay logic) plus js-edit hint scaffolding to `tools/dev/js-scan.js`.
- Updated `what-imports`/`export-usage` JSON output paths to wrap results in AI-native envelopes and emit continuation tokens.
- Extended the continuation handler to branch on new action types (`importer-analyze`, `usage-import`, `usage-call`, `usage-reexport`).
- Added smoke tests ensuring relationship queries emit tokens and continuations return importer/usage metadata.
- Implemented js-edit ingestion: new CLI flags (`--match-snapshot`, `--from-token`), stdin readers, TokenCodec hydrator, and mutation op entry point that emits guard plans straight from js-scan snapshots/tokens.
- Expanded AI-native smoke suite to cover snapshot + stdin token ingestion, ensuring BatchDryRunner refuses mismatched hashes and mirrors `--locate --emit-plan` output.

## Verify
- `npm run test:by-path tests/tools/ai-native-cli.smoke.test.js`

## Next
- Expose optional ripple actions for relationship tokens once agents request them.
- Build recipe templates so js-scan continuation payloads can jump straight into guarded `js-edit --replace` flows (plan ingestion is shipped; edits still manual).
- Document guard mismatch remediation + caching advice inside TOOLING references and lessons learned.

---

## Session: URL Filter Toggle Fix

### Sense
- Reviewed UrlFilterToggle control, data explorer server, and client activation sources to map the SSR/CSR boundaries.
- Confirmed consumers via `node tools/dev/js-scan.js --what-imports src/ui/controls/UrlFilterToggle.js --json` before planning edits.

### Plan
- Logged session plan under `docs/sessions/2025-11-21-url-filter-toggle/PLAN.md` with goals (table refresh, pagination sync, diagnostics, tests).
- Scoped verification to the Puppeteer toggle suite plus server-side production snapshot tests once code lands.

### Act
- _Pending once implementation begins._

### Verify
- _Pending — will capture targeted test commands/results after code changes._

## Session: Diagram Atlas Buttons & Screenshot Caps

### Sense
- Revisited `diagramAtlasControlsFactory.js` to understand how the Database Structure grid tiles are sized/styled and why long table names wrap.
- Reviewed the Puppeteer helpers (`capture-data-explorer-screenshots.js`, `capture-diagram-atlas-screenshot.js`) plus prior session notes to confirm how screenshots are produced and logged.

### Plan
- Enlarge the Database Structure “buttons” by introducing a DB-specific tile variant so SSR + hydration both respect the wider layout.
- Clamp Puppeteer captures to a 1200px viewport/clip height and regenerate the screenshot sets (data explorer batch, domain detail, diagram atlas) with the new limit.

### Act
- Added a `diagram-tile--db` variant (auto layout, grid columns) so each table tile spans at least 420px without inline width/height, preventing wrapped labels.
- Updated both screenshot helpers to enforce a 1200px maximum (viewport sanitize + clip bounding boxes) and recorded the limit inside the data explorer manifest.
- Re-ran Diagram Atlas SSR checks plus all screenshot scripts to refresh PNG/HTML artifacts under `screenshots/` and `diagram-atlas.check.html`.

### Verify
- `node src/ui/server/checks/diagramAtlas.check.js`
- `cmd /c "node scripts/ui/capture-data-explorer-screenshots.js --routes urls,urls-fetched,domains,crawls,errors,url-detail,domain-detail --html > tmp/data-explorer-screens.log 2>&1"`
- `cmd /c "node scripts/ui/capture-domain-detail-screenshot.js --html > tmp/domain-detail-screenshot.log 2>&1"`
- `npm run diagram:screenshot`
