# Lessons & Patterns (Rolling)

## 2025-11-16
- **Document-First Success**: Creating `/docs/agi` before coding changes keeps AGI initiatives decoupled from production flows.
- **Tool Awareness**: Re-reading `AGENTS.md` plus GitHub Copilot instructions provided enough context; no need for deep code scans yet. Respect the "stop researching early" directive.
- **Journal Discipline**: Logging plan + open questions in `journal/2025-11-16.md` made the rest of the work straightforward and should remain standard practice.
- **Static Analysis Focus**: Reiterating `js-scan`/`js-edit` as Tier-1 tools prevents scope creep toward unsupported tooling (e.g., Python scripts).
- **Existing Agent Review**: Always scan canonical specs in `docs/agents/` (e.g., `agent_policy`, `docs_indexer_and_agents_refactorer`) before drafting new personas so proposals inherit current governance.
- **Meta-Tooling Insight**: Running js-scan against the tooling sources (`tools/dev/js-scan/**`) reveals dependency risk before modifying the scanners themselves‚Äîcapture these findings in `docs/agi/tools/*` to keep institutional memory tight.
- **Guard Replay Discipline**: Documented `js-edit` guard plans plus storage locations (e.g., `docs/sessions/<date>`) so future agents can replay edits without recomputing selectors; skip this step only if re-locating is trivial.

## 2025-12-13
- **Skills are ‚Äúcapability packs,‚Äù not prompt snippets**: The key value isn‚Äôt a better prompt‚Äîit‚Äôs a discoverable bundle of triggers + SOP + scripts/checks/tests + success criteria, surfaced via a registry/query tool so agents can activate it without ‚Äúremembering‚Äù it exists.

## 2025-11-20
- **Token Payloads Need Context**: Continuation tokens are only useful when they carry the absolute file, selector, and guard hash‚Äîembed the `match` snapshot at creation time so replay steps never re-scan unless inputs are missing.
- **Handlers Before Features**: Implement practical action handlers (`analyze`, `trace`, `ripple`) before adding new token types; tests now exercise each path so regressions surface immediately.
- **Record Commands Inline**: Session notes now log both the discovery run and the replay/test commands; this keeps token strings + JSON outputs paired for future verification.
- **Warn on Drift**: Digest comparisons (`RESULTS_DIGEST_MISMATCH`) give downstream agents an immediate signal that cached selectors are stale, so refresh tokens before touching js-edit.

## 2025-11-21
- **Relationship results need parity**: `what-imports`/`export-usage` already return importer metadata, but without tokenization those lists cannot flow into downstream automation‚Äîtreat each importer/usage row like a search match (file, specifier, digest) so continuation tooling applies uniformly.
- **js-edit should trust snapshots, not humans**: The `match` payload and `jsEditHint` already contain enough guard info for edits; lacking an ingestion flag just forces extra `--locate` runs. Building a token/snapshot entry point unlocks single-pass Sense‚ÜíAct loops.
- **Digest everything**: When relationship payloads start emitting tokens, compute and store a composite digest (sorted importer list hash) so stale tokens trigger the same `RESULTS_DIGEST_MISMATCH` warning that protects search tokens today.
- **Cap tokens for ergonomics**: Limiting importer/usage actions to 10 per request balances usefulness with compact `_ai_native_cli` payloads; agents can always rerun with narrower filters if they need more snapshots.
- **Session breadcrumbs matter**: Pair every tooling push with a fresh journal entry + session folder and link it from `SESSIONS_HUB.md`; future agents depend on those breadcrumbs to resume the work without rediscovery.
- **Smoke it where it hurts**: Extending the AI-native smoke suite immediately after wiring snapshot ingestion caught a regression around hash mismatches; keep the suite as the canonical repro for Sense‚ÜíAct handoffs instead of ad-hoc manual runs.

## 2025-12-03
- **MCP vs CLI Tool Adoption**: MCP tools command more agent attention than CLI equivalents because they're declared affordances (push discovery) rather than scripts requiring active recall (pull discovery). Agents may over-use MCP tools simply because they're visible in the tool inventory.
- **Session Discipline**: Before appending to any session with `appendToSession`, always (1) use `listSessions` to see what exists, (2) use `searchSessions` if unsure which session matches the task, (3) specify the correct `slug` explicitly ‚Äî never rely on "latest session" default when working on a specific task. Cross-contaminating sessions defeats the purpose of persistent memory.
- **MCP Tool Design for Context Efficiency**: MCP tools that return documentation should support filtering parameters (e.g., `files`, `maxLinesPerFile`, `sinceDate`) so agents can request only what they need. Returning full files by default wastes context tokens and risks information overload. Implemented in docs-memory: `getSession` now accepts `files` array and `maxLinesPerFile`; `getLessons` now accepts `sinceDate` filter.
- **Self-Documenting MCP Tools**: Tool descriptions are the PRIMARY place for usage guidance ‚Äî they're visible to the model before tool selection. Lessons are secondary (must be fetched). Pattern: (1) Embed RECOMMENDED WORKFLOW directly in tool description, (2) Add `onlyStats` or similar cheap-probe options, (3) Return `hint` fields in responses suggesting next actions. This makes tools self-improving without requiring agents to read lessons first.
- **Workflow MCP Tools (AGI Singularity Enabled)**: Added workflow management tools to docs-memory MCP server: listWorkflows, getWorkflow (with structured metadata extraction), searchWorkflows, and proposeWorkflowImprovement. Key design: (1) Workflows are parsed to extract phases, prerequisites, checklists, and commands; (2) 'improvementHooks' field identifies optimization opportunities for agents; (3) proposeWorkflowImprovement saves proposals to docs/agi/workflow-improvements/ for human/senior-agent review. This enables meta-workflows where agents can improve workflows themselves.
- MCP memory server enhanced with 8 new tools for session continuity (findOrContinueSession, getTaskProgress), pattern catalogs (addPattern, addAntiPattern, getPatterns, getAntiPatterns), and knowledge map tracking (updateKnowledgeMap, getKnowledgeMap). These tools enable the  Careful Refactor  agent self-improvement loop.
- Before introducing a factory pattern, verify the target class doesn't already support dependency injection. NewsCrawler already had _applyInjectedServices() making CrawlerFactory redundant. Check existing constructor signatures before adding abstraction layers.
- **safeCall Pattern**: Created `safeCall(fn, fallback)` utility for wrapping fire-and-forget calls that should never throw. Reduces 4-line try-catch blocks to single-line calls: `try { x(); } catch (_) {}` ‚Üí `safeCall(() => x())`. Added to `src/crawler/utils.js` with companion `safeCallAsync` and `safeHostFromUrl`.
- **DRY Principle**: Identified duplicate `safeHostFromUrl` in DomainThrottleManager that was redundant with utility. Refactored to use shared implementation. Always check utils module before implementing domain logic.
- **Fire-and-Forget Callbacks**: 20+ instances across crawler where telemetry/state/problem callbacks should never throw. Pattern: wrap with `safeCall(() => callback())` for consistency. Found in NewsCrawler, dbClient, ErrorTracker, FetchPipeline, QueueManager.
- When refactoring repeated try/catch patterns: (1) Extract to shared utility first, (2) Add tests for the utility, (3) Then migrate call sites. This order ensures the utility is stable before widespread adoption.
- When mocking a module in Jest that you've recently added exports to, use `jest.mock('./module', () => ({ ...jest.requireActual('./module'), overriddenFn: mockFn }))` to avoid "X is not a function" errors from missing exports.
- The `_callX(methodName, fallback, ...args)` delegation pattern reduces ~5 lines per method to 1 line while preserving identical semantics. Good ROI for classes with many forwarding methods.

## 2025-12-03 NewsCrawler Modularization Analysis
- NewsCrawler.js (2579 lines) already uses heavy service extraction via dependency injection (25+ services in _applyInjectedServices). The 'wireCrawlerServices' function (line 2280+) shows the wiring pattern. Remaining modularization targets are: (1) Problem Resolution handling (~100 lines, very isolated), (2) Startup/Sequence orchestration (~350 lines, high coupling to init), (3) Priority computation logic (~150 lines, pure functions could become a PriorityCalculator service), (4) Exit/finalization logic (~100 lines). Most impactful: Extract PriorityCalculator as it's pure computation with no side effects.
- Key method groups in NewsCrawler.js for extraction consideration: INIT GROUP (init, _trackStartupStage, _skipStartupStage, _markStartupComplete, _emitStartupProgress), EXECUTION GROUP (_runSequentialLoop, _runConcurrentWorkers, _pullNextWorkItem, _ensureWorkerRunner), SEQUENCE GROUP (_runCrawlSequence, _ensureStartupSequenceRunner, _shouldUseSequenceRunner), PLANNER GROUP (_runPlannerStage, _ensureIntelligentPlanRunner), SITEMAP GROUP (_runSitemapStage, loadRobotsTxt, loadSitemapsAndEnqueue), PROBLEM RESOLUTION GROUP (_handleProblemResolution, _hydrateFromHistory), PRIORITY GROUP (computePriority, computeEnhancedPriority, _applyHubFreshnessPolicy, _isHubLikeRequest), EXIT GROUP (_recordExit, _describeExitSummary, getExitSummary, _determineOutcomeError, _finalizeRun).
- RECOMMENDED EXTRACTION ORDER for NewsCrawler.js: (1) PriorityCalculator - pure functions, zero risk, immediate value for testing; (2) ExitManager - isolated exit/finalization logic; (3) ProblemResolutionHandler - small and cohesive; (4) StartupOrchestrator - higher coupling but clear boundary. AVOID extracting: _runSequentialLoop/_runConcurrentWorkers as they're tightly coupled to state transitions and already work correctly. The 'wireCrawlerServices' function at line 2280 is the integration point - new services get wired there for backward compatibility with non-DI callers.

## jsgui3 Pattern Catalog
- Use a lightweight jsgui3 pattern catalog: for each control pattern, store name, intent, control path, check script path, jest spec path, e2e spec path, sample data, run commands, expected duration (<10s), status, and gotchas. Place minimal examples under src/ui/controls/examples/<pattern>/ with a reusable harness (tests/helpers/jsgui3Harness.js) that renders, registers, activates, and runs a scripted interaction. Provide quick node check scripts under src/ui/controls/examples/<pattern>/checks/, a Jest unit/activation test, and a Playwright/puppeteer smoke test. Keep built artifacts git-ignored (e.g., public/examples/). Record each pattern‚Äôs testing recipe in docs/guides/jsgui3_pattern_catalog.md and keep entries in memory for reuse.

2025-12-10
- HierarchicalPlanner should always return a partial plan: track the best explored node during branch-and-bound and fall back when no goal state is reached to avoid null plan.steps failures in integration tests.
- Pattern learning must handle single-action sequences and missing success flags; infer success from expected vs actual values (>=70%) and accept single-step actionSequence to keep planning_heuristics populated for cross-domain sharing.

## 2025-12-10 - SVG Theming & Visual Design
- **Gemstone Button Pattern**: For luxury UI buttons, use a 3-layer structure: (1) outer frame rect with obsidian fill + brushed metal stroke, (2) inner gem rect with gradient fill + glow filter, (3) white bold text centered. Frame should be 7px larger than gem on each side. Apply `filter="url(#gemGlow)"` to the gem layer only.
- **Gemstone Gradient Recipe**: Ruby = #e74c5e ‚Üí #c21f32 ‚Üí #8d1424 (bright ‚Üí rich ‚Üí deep). Emerald = #2dd4bf ‚Üí #1a8f4d ‚Üí #0f5f33. Sapphire = #60a5fa ‚Üí #1e5aad ‚Üí #123a74. Use 0%/50%/100% stops for gem-like depth. Direction: x1="0%" y1="0%" x2="100%" y2="100%" for diagonal shine.
- **Brushed Metal Gradient**: Create alternating light/dark bands for brushed metal effect. Use 5 stops: 0%=#e5e1d7, 25%=#d8cba9, 50%=#e5e1d7, 75%=#d8cba9, 100%=#e5e1d7. This creates subtle striation that mimics brushed white gold/platinum.
- **Obsidian Frame Colors**: Dark luxury industrial look uses #1a1f2e (lighter obsidian) ‚Üí #0a0d14 (deep black). Pair with brushed gold stroke (#d8cba9) for elegant contrast. Header bars should use rx="12" for rounded corners, with a bottom rect (no radius) to create flat bottom edge.
- **Drop Shadow Filter Recipe**: `<filter id="dropShadow" x="-20%" y="-20%" width="140%" height="140%">` with feOffset(dx=0, dy=4), feGaussianBlur(stdDeviation=8), feBlend(mode=normal). Apply to panels and node frames for depth. Gem glow uses feGaussianBlur(stdDeviation=3) + feComposite(operator=over) for subtle luminescence.
- **Decision Tree Edge Curves**: Use cubic bezier paths for organic flow: `M startX startY C startX controlY, endX controlY, endX endY`. The control points should be at ~40% vertical distance. Example: root at y=60 to child at y=170 uses control at y=100 and y=130.
- **SVG Layout Hierarchy (White Leather √ó Obsidian)**: Layer order matters! (1) bgGradient rect (white‚Üícream), (2) mainPanel with brushedMetal + dropShadow, (3) headerBar with obsidianFrame, (4) canvasArea (near-white #fdfcfa), (5) sidebar (obsidian), (6) edges (paths), (7) nodes with frames, (8) text labels. Always define gradients/filters in `<defs>` first.
- **Form Field Styling in SVG**: Use brushedMetal gradient fill for input backgrounds with 1px stroke in gold (#d8cba9). Labels in muted gold (#d8cba9, 11px), values in dark (#1a1f2e, 12px) offset 10px from left edge. Group in `<g transform="translate(x,y)">` for easy positioning.
- **SVG Quick-Start Checklist for Non-Artist Agents**: (1) Read `tools/dev/svg-templates/THEMING_COOKBOOK.md`, (2) Copy defs from `snippets/white-leather-obsidian-defs.json`, (3) Follow layer order: background‚Üípanels‚Üíheader‚Üícontent‚Üíedges‚Üínodes‚Üítext, (4) Use 3-layer button pattern (frame+gem+text), (5) Apply dropShadow to frames, gemGlow to gems only, (6) Validate with `svg_detect_collisions --onlyStats` for 0 HIGH issues.
- **Theme Resource Locations**: Themes JSON at `tools/dev/svg-templates/themes/`, cookbook at `THEMING_COOKBOOK.md`, snippets at `snippets/*.json`, example at `tmp/decision-tree-editor-v2.svg`. Query `svg_theme { action: "list" }` for available themes, `svg_theme { action: "get", name: "white-leather-obsidian" }` for full palette.

## 2025-01-25
- **2D SVG Spatial Reasoning Book Complete** - Created comprehensive 14-chapter book at /docs/books/2d-svg-spatial-reasoning/ covering: coordinate systems, geometric primitives, transforms, paths, B√©zier curves, arcs, bounding boxes, collision detection, containment, positioning, spacing, tree/graph layouts, layer order, and repair toolkit. Each chapter includes formulas, code examples, decision trees, and checklists designed for AI models of varying capability levels.

## 2025-12-11
- For jsgui3 work, prefer md-scan discovery + lab experiments over ad-hoc debugging: search guides/docs/sessions first, then build a minimal src/ui/lab experiment with a check script and (when event semantics matter) run the delegation suite scenarios to validate bubbling/capture/selector behavior before promoting changes into production code.
- When bundling isomorphic controls, prefer small shared utilities (e.g. ListenerBag) but verify the relative require path works for both Node runtime and esbuild browser bundling; rebuild the client bundle before E2E to ensure the browser path uses the updated code.
- When a Puppeteer E2E exercises bundled client JS, always confirm `client.bundle.js` is current. If behavior contradicts recent code edits (or in-browser debug hooks never appear), rebuild the bundle first (`node scripts/build-art-playground-client.js`) before chasing app-level logic.

## 2025-12-12
- **JavaScript backslash escaping for SQL ESCAPE clauses**: `'\\'` produces a single backslash, `'\\\\'` produces two. When SQLite expects `ESCAPE '\'` in the SQL string, use `ESCAPE '\\'` in JS code (one level of escaping). Using `ESCAPE '\\\\'` sends two backslashes and fails with "ESCAPE expression must be a single character".
- **Jest testPathIgnorePatterns catches test files too**: The pattern `/helpers/` in Jest config is meant to skip test helper utilities, but it also blocks any test file placed in a `helpers/` directory. Place tests in the parent directory or rename the folder.
- Claude-like ‚Äúskills‚Äù map well to repo-native capability packs: a small directory with a clear entry doc (SKILL.md), a registry/index, and ready-to-run commands/checks so any agent can self-serve the workflow without bespoke prompting.
- A skills system needs a discovery surface. A registry (e.g., docs/agi/SKILLS.md) + lightweight search (sessions/workflows) reduces handover friction more than adding more raw docs.
- Progressive disclosure: keep skill packs short and action-oriented (triggers ‚Üí commands ‚Üí validation ‚Üí escalation). Put deep detail in linked guides/sessions; keep the SKILL.md as the runnable SOP.
- Tooling reality check: MCP tool availability can be environment-gated; docs should explicitly document activation steps and CLI fallbacks so agents don‚Äôt abandon the memory system when tools aren‚Äôt visible.
- If you want systematic memory adoption, bake a ‚Äúmemory-first + error-reporting contract‚Äù directly into key agent persona files (orchestrator + main working agents). Tool failures should be user-visible and produce a follow-up that proposes an improvement.
- Make the ‚ÄúMemory System Contract‚Äù a shared, copy-pastable snippet and roll it into high-traffic agent personas so memory-first behavior becomes systemic (pre-flight ‚Üí session discovery ‚Üí post-work persistence ‚Üí visible error escalation).
- If an agent persona file lacks frontmatter (description/tools), add it so capability/tool access can be explicitly declared and enforced (including `docs-memory/*`).
- When improving agent personas, prefer short ‚Äúevidence contract‚Äù snippets + links to authoritative guides/workflows over duplicating long protocols; replace PowerShell/Unix pipeline examples with replayable repo-standard Node CLIs (`tools/dev/js-scan.js`, `tools/dev/js-edit.js`, `tools/dev/md-scan.js`) to keep research steps deterministic.

## 2025-12-13 jsgui3 Controls
- **jsgui3 Control Factory vs Direct Export**: Use factory functions (`createXxxControl(jsgui, deps)`) when the control needs testability with mocked jsgui or shared dependencies; use direct class export for simple self-contained controls. The factory pattern enables DI for unit testing without requiring real jsgui instances.
- **Control Type Registration for Client Activation**: Every control that renders on the server and activates on the client needs: (1) `__type_name` in constructor spec, (2) registration via `registerControlType(typeName, ControlClass)`, (3) addition to `controlManifest.js` loader. Missing any step breaks client-side hydration with cryptic `map_Controls` errors.
- **Check Scripts as Control Documentation**: Every shared control should have a `checks/XxxControl.check.js` that: (1) instantiates with representative data, (2) renders HTML, (3) asserts expected structure, (4) outputs the HTML for visual inspection. Check scripts serve as executable documentation and catch SSR regressions faster than E2E tests.
- **BEM-ish CSS Class Naming for Controls**: Use `.control-name` for base, `.control-name__element` for children, `.control-name--modifier` for states/variants. This creates predictable, non-colliding CSS and enables query selectors in activate() like `this._rootEl.querySelector('.control-name__inner')`.
- **State vs Config Pattern**: Store immutable configuration in `this._config = {}` and mutable runtime state in `this._state = {}`. This separation makes it clear what can change after construction and simplifies debugging. Config is set once in constructor; state changes via public methods.
- **Activation Guard Pattern**: Always guard activate() with a flag: `if (this.__activated) return; this.__activated = true;`. Multiple activations cause duplicate event handlers. The naming convention `__activated` or `__activatedOnce` signals it's a framework-level guard.
- **Data Attributes for Client-Side Config**: Store configuration in `data-*` attributes during SSR so the client can read it during activation. Pattern: `this.dom.attributes['data-api-path'] = this._config.apiPath;` in SSR, then `this._rootEl.getAttribute('data-api-path')` during activate(). This keeps config in sync without global state.
- **Control Discovery via Check Scripts**: To understand how a control works, first run its check script (`node src/ui/controls/checks/XxxControl.check.js`) - the output shows rendered HTML and validates expected structure. Check scripts are executable documentation that stays in sync with implementation.
- **Composition over Control Inheritance**: Prefer composing controls (adding child controls via `this.add()`) over class inheritance. Most controls should extend `jsgui.Control` directly and compose children. Use inheritance only for true IS-A relationships like `DomainDownloadsTableControl extends TableControl`.
- **StringControl for Text Nodes**: Always use `jsgui.String_Control` for text content: `this.add(new jsgui.String_Control({ context, text: value }))`. Never use string concatenation in all_html_render() - let jsgui handle escaping. The String_Control properly handles HTML entities and special characters.
- Standardize user-visible memory access feedback to a single badge line (`üß† MEMORY ‚Äî ...`) and emit it only once per distinct retrieval (repeat only when sources/loaded items change) to avoid chat noise.
- Windows-safe emoji search: avoid literal emoji in CLI input; use `md-scan --find-emojis` to discover `utf8Hex`/`utf8Base64`, then search via `--search b16:<hex>` or `--search b64:<base64>`. Generate encodings via `tools/dev/emoji-encode.js --codepoint ...` to avoid shell/encoding stripping.
- When adding a reusable jsgui3 control under `src/ui/controls/`, also update the canonical catalog (`docs/guides/JSGUI3_SHARED_CONTROLS_CATALOG.md`) with a short entry + usage snippet so future agents don‚Äôt rediscover it via grep.
