<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1100 780">
  <defs>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="4" stdDeviation="6" flood-opacity="0.12"/>
    </filter>
    <filter id="shadow-sm" x="-10%" y="-10%" width="120%" height="120%">
      <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.1"/>
    </filter>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <path d="M 0 0 L 10 3.5 L 0 7 L 2 3.5 Z" fill="#64748b"/>
    </marker>
    <marker id="arrow-purple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <path d="M 0 0 L 10 3.5 L 0 7 L 2 3.5 Z" fill="#8b5cf6"/>
    </marker>
    <linearGradient id="rest" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#fb923c"/><stop offset="100%" stop-color="#f97316"/>
    </linearGradient>
    <linearGradient id="wiki" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#4ade80"/><stop offset="100%" stop-color="#22c55e"/>
    </linearGradient>
    <linearGradient id="osm" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#818cf8"/><stop offset="100%" stop-color="#6366f1"/>
    </linearGradient>
    <linearGradient id="coord" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#a78bfa"/><stop offset="100%" stop-color="#8b5cf6"/>
    </linearGradient>
    <linearGradient id="db" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#60a5fa"/><stop offset="100%" stop-color="#3b82f6"/>
    </linearGradient>
  </defs>
  
  <!-- Background -->
  <rect width="1100" height="780" fill="#f8fafc"/>
  
  <!-- Header -->
  <rect width="1100" height="75" fill="#0f172a"/>
  <text x="550" y="35" font-family="Inter, system-ui, sans-serif" font-size="24" font-weight="700" text-anchor="middle" fill="#ffffff">Gazetteer Ingestion Data Flow</text>
  <text x="550" y="58" font-family="Inter, system-ui, sans-serif" font-size="13" text-anchor="middle" fill="#94a3b8">External APIs → Ingestors → SQLite Tables</text>
  
  <!-- External APIs Section -->
  <rect x="30" y="95" width="300" height="360" rx="14" fill="#ffffff" stroke="#e2e8f0" stroke-width="2" filter="url(#shadow)"/>
  <text x="180" y="125" font-family="Inter, system-ui, sans-serif" font-size="12" font-weight="700" text-anchor="middle" fill="#0f172a" letter-spacing="0.5">EXTERNAL DATA SOURCES</text>
  
  <!-- REST Countries -->
  <g filter="url(#shadow-sm)">
    <rect x="50" y="145" width="260" height="100" rx="10" fill="url(#rest)"/>
    <text x="180" y="173" font-family="Inter, system-ui, sans-serif" font-size="14" font-weight="700" text-anchor="middle" fill="#ffffff">REST Countries API v3.1</text>
    <line x1="80" y1="185" x2="280" y2="185" stroke="#ffffff" stroke-opacity="0.3"/>
    <text x="180" y="205" font-family="Inter, system-ui, sans-serif" font-size="10" text-anchor="middle" fill="#ffedd5">Countries, Capitals, Flags</text>
    <text x="180" y="220" font-family="Inter, system-ui, sans-serif" font-size="10" text-anchor="middle" fill="#ffedd5">Population, ISO codes, Currencies</text>
    <text x="180" y="235" font-family="Inter, system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#fed7aa">restcountries.com/v3.1/all</text>
  </g>
  
  <!-- Wikidata -->
  <g filter="url(#shadow-sm)">
    <rect x="50" y="260" width="260" height="100" rx="10" fill="url(#wiki)"/>
    <text x="180" y="288" font-family="Inter, system-ui, sans-serif" font-size="14" font-weight="700" text-anchor="middle" fill="#ffffff">Wikidata SPARQL</text>
    <line x1="80" y1="300" x2="280" y2="300" stroke="#ffffff" stroke-opacity="0.3"/>
    <text x="180" y="320" font-family="Inter, system-ui, sans-serif" font-size="10" text-anchor="middle" fill="#dcfce7">ADM1: States, Provinces, Regions</text>
    <text x="180" y="335" font-family="Inter, system-ui, sans-serif" font-size="10" text-anchor="middle" fill="#dcfce7">ADM2: Counties, Districts, Cities</text>
    <text x="180" y="350" font-family="Inter, system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#bbf7d0">query.wikidata.org/sparql</text>
  </g>
  
  <!-- OSM -->
  <g filter="url(#shadow-sm)">
    <rect x="50" y="375" width="260" height="70" rx="10" fill="url(#osm)"/>
    <text x="180" y="403" font-family="Inter, system-ui, sans-serif" font-size="14" font-weight="700" text-anchor="middle" fill="#ffffff">OSM Overpass API</text>
    <text x="180" y="423" font-family="Inter, system-ui, sans-serif" font-size="10" text-anchor="middle" fill="#e0e7ff">Admin boundaries, GeoJSON polygons</text>
    <text x="180" y="438" font-family="Inter, system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#c7d2fe">overpass-api.de/api</text>
  </g>
  
  <!-- Ingestors Section -->
  <rect x="390" y="95" width="300" height="360" rx="14" fill="#ffffff" stroke="#e2e8f0" stroke-width="2" filter="url(#shadow)"/>
  <text x="540" y="125" font-family="Inter, system-ui, sans-serif" font-size="12" font-weight="700" text-anchor="middle" fill="#0f172a" letter-spacing="0.5">INGESTORS (Sequential)</text>
  
  <!-- Coordinator -->
  <g filter="url(#shadow-sm)">
    <rect x="410" y="145" width="260" height="50" rx="8" fill="url(#coord)"/>
    <text x="540" y="168" font-family="Inter, system-ui, sans-serif" font-size="12" font-weight="700" text-anchor="middle" fill="#ffffff">GazetteerIngestionCoordinator</text>
    <text x="540" y="185" font-family="Inter, system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#e9d5ff">Orchestrates sequential execution</text>
  </g>
  
  <!-- Ingestor 1 -->
  <rect x="410" y="210" width="260" height="45" rx="6" fill="#fef2f2" stroke="#fecaca" stroke-width="1.5"/>
  <text x="428" y="230" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="700" fill="#dc2626">1.</text>
  <text x="446" y="230" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="600" fill="#b91c1c">WikidataCountryIngestor</text>
  <text x="540" y="246" font-family="Inter, system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#f87171">Countries + capitals first</text>
  
  <!-- Ingestor 2 -->
  <rect x="410" y="265" width="260" height="45" rx="6" fill="#fff7ed" stroke="#fed7aa" stroke-width="1.5"/>
  <text x="428" y="285" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="700" fill="#ea580c">2.</text>
  <text x="446" y="285" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="600" fill="#c2410c">WikidataAdm1Ingestor</text>
  <text x="540" y="301" font-family="Inter, system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#fb923c">States/provinces (needs parent)</text>
  
  <!-- Ingestor 3 -->
  <rect x="410" y="320" width="260" height="45" rx="6" fill="#f0fdf4" stroke="#bbf7d0" stroke-width="1.5"/>
  <text x="428" y="340" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="700" fill="#16a34a">3.</text>
  <text x="446" y="340" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="600" fill="#15803d">WikidataCitiesIngestor</text>
  <text x="540" y="356" font-family="Inter, system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#4ade80">Major cities (needs ADM1)</text>
  
  <!-- Ingestor 4 -->
  <rect x="410" y="375" width="260" height="45" rx="6" fill="#eff6ff" stroke="#bfdbfe" stroke-width="1.5"/>
  <text x="428" y="395" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="700" fill="#2563eb">4.</text>
  <text x="446" y="395" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="600" fill="#1d4ed8">OsmBoundaryIngestor</text>
  <text x="540" y="411" font-family="Inter, system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#60a5fa">Boundary geometry (links by QID)</text>
  
  <!-- Process note -->
  <rect x="410" y="430" width="260" height="35" rx="5" fill="#f1f5f9" stroke="#cbd5e1"/>
  <text x="540" y="452" font-family="Inter, system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#64748b">Sequential • Rate limits • Dependencies</text>
  
  <!-- SQLite Tables Section -->
  <rect x="750" y="95" width="320" height="360" rx="14" fill="#ffffff" stroke="#e2e8f0" stroke-width="2" filter="url(#shadow)"/>
  <text x="910" y="125" font-family="Inter, system-ui, sans-serif" font-size="12" font-weight="700" text-anchor="middle" fill="#0f172a" letter-spacing="0.5">SQLITE TABLES (gazetteer.db)</text>
  
  <!-- Tables grid -->
  <g filter="url(#shadow-sm)">
    <rect x="770" y="145" width="130" height="55" rx="6" fill="url(#db)"/>
    <text x="835" y="168" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="700" text-anchor="middle" fill="#ffffff">places</text>
    <text x="835" y="185" font-family="Inter, system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">id, kind, population</text>
    <text x="835" y="196" font-family="Inter, system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#93c5fd">coords, wikidata_qid</text>
  </g>
  
  <g filter="url(#shadow-sm)">
    <rect x="920" y="145" width="130" height="55" rx="6" fill="url(#db)"/>
    <text x="985" y="168" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="700" text-anchor="middle" fill="#ffffff">place_names</text>
    <text x="985" y="185" font-family="Inter, system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">Multi-lingual names</text>
    <text x="985" y="196" font-family="Inter, system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#93c5fd">aliases, normalized</text>
  </g>
  
  <g filter="url(#shadow-sm)">
    <rect x="770" y="215" width="130" height="55" rx="6" fill="url(#db)"/>
    <text x="835" y="238" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="700" text-anchor="middle" fill="#ffffff">place_hierarchy</text>
    <text x="835" y="255" font-family="Inter, system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">parent_id, child_id</text>
    <text x="835" y="266" font-family="Inter, system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#93c5fd">relation_type</text>
  </g>
  
  <g filter="url(#shadow-sm)">
    <rect x="920" y="215" width="130" height="55" rx="6" fill="url(#db)"/>
    <text x="985" y="238" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="700" text-anchor="middle" fill="#ffffff">place_external_ids</text>
    <text x="985" y="255" font-family="Inter, system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">Wikidata QID</text>
    <text x="985" y="266" font-family="Inter, system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#93c5fd">OSM, GeoNames</text>
  </g>
  
  <g filter="url(#shadow-sm)">
    <rect x="770" y="285" width="130" height="55" rx="6" fill="url(#db)"/>
    <text x="835" y="308" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="700" text-anchor="middle" fill="#ffffff">place_sources</text>
    <text x="835" y="325" font-family="Inter, system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">Data provenance</text>
    <text x="835" y="336" font-family="Inter, system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#93c5fd">source_url, fetched_at</text>
  </g>
  
  <g filter="url(#shadow-sm)">
    <rect x="920" y="285" width="130" height="55" rx="6" fill="url(#db)"/>
    <text x="985" y="308" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="700" text-anchor="middle" fill="#ffffff">place_attributes</text>
    <text x="985" y="325" font-family="Inter, system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">Extensible attrs</text>
    <text x="985" y="336" font-family="Inter, system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#93c5fd">GDP, area, timezone</text>
  </g>
  
  <g filter="url(#shadow-sm)">
    <rect x="770" y="355" width="130" height="55" rx="6" fill="url(#db)"/>
    <text x="835" y="378" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="700" text-anchor="middle" fill="#ffffff">ingestion_runs</text>
    <text x="835" y="395" font-family="Inter, system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">Audit log</text>
    <text x="835" y="406" font-family="Inter, system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#93c5fd">started_at, stats</text>
  </g>
  
  <g filter="url(#shadow-sm)">
    <rect x="920" y="355" width="130" height="55" rx="6" fill="url(#db)"/>
    <text x="985" y="378" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="700" text-anchor="middle" fill="#ffffff">http_responses</text>
    <text x="985" y="395" font-family="Inter, system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">Cached API calls</text>
    <text x="985" y="406" font-family="Inter, system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#93c5fd">request/response</text>
  </g>
  
  <!-- Cache layer -->
  <rect x="770" y="420" width="280" height="35" rx="5" fill="#fefce8" stroke="#fde047" stroke-width="1.5"/>
  <text x="910" y="440" font-family="Inter, system-ui, sans-serif" font-size="10" font-weight="600" text-anchor="middle" fill="#854d0e">HttpRequestResponseFacade</text>
  <text x="910" y="452" font-family="Inter, system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#a16207">Caches external API responses</text>
  
  <!-- Arrows: APIs → Ingestors -->
  <path d="M 310 195 L 410 232" fill="none" stroke="#f97316" stroke-width="2" marker-end="url(#arrow)"/>
  <path d="M 310 285 L 410 232" fill="none" stroke="#22c55e" stroke-width="2" marker-end="url(#arrow)"/>
  <path d="M 310 310 L 410 287" fill="none" stroke="#22c55e" stroke-width="2" marker-end="url(#arrow)"/>
  <path d="M 310 330 L 410 342" fill="none" stroke="#22c55e" stroke-width="2" marker-end="url(#arrow)"/>
  <path d="M 310 410 L 410 397" fill="none" stroke="#6366f1" stroke-width="2" marker-end="url(#arrow)"/>
  
  <!-- Arrows: Ingestors → Tables -->
  <path d="M 670 232 L 770 172" fill="none" stroke="#8b5cf6" stroke-width="2" marker-end="url(#arrow-purple)"/>
  <path d="M 670 287 L 770 242" fill="none" stroke="#8b5cf6" stroke-width="2" marker-end="url(#arrow-purple)"/>
  <path d="M 670 342 L 770 172" fill="none" stroke="#8b5cf6" stroke-width="1.5" stroke-dasharray="4,3" marker-end="url(#arrow-purple)"/>
  <path d="M 670 397 L 770 312" fill="none" stroke="#8b5cf6" stroke-width="1.5" stroke-dasharray="4,3" marker-end="url(#arrow-purple)"/>
  
  <!-- Deduplication Strategy -->
  <rect x="30" y="480" width="1040" height="125" rx="12" fill="#ffffff" stroke="#e2e8f0" stroke-width="1" filter="url(#shadow)"/>
  <text x="50" y="510" font-family="Inter, system-ui, sans-serif" font-size="13" font-weight="700" fill="#0f172a">Deduplication Strategy</text>
  
  <text x="50" y="538" font-family="Inter, system-ui, sans-serif" font-size="11" fill="#475569">
    <tspan font-weight="600" fill="#334155">1. Check External IDs:</tspan> Query place_external_ids for wikidata:Q123, restcountries:capital:GB:london
  </text>
  <text x="50" y="560" font-family="Inter, system-ui, sans-serif" font-size="11" fill="#475569">
    <tspan font-weight="600" fill="#334155">2. Update if exists:</tspan> Merge new attributes and names into existing record
  </text>
  <text x="50" y="582" font-family="Inter, system-ui, sans-serif" font-size="11" fill="#475569">
    <tspan font-weight="600" fill="#334155">3. Insert if new:</tspan> Create new places record with all external IDs linked
  </text>
  <text x="50" y="604" font-family="Inter, system-ui, sans-serif" font-size="11" fill="#475569">
    <tspan font-weight="600" fill="#334155">4. Build hierarchy:</tspan> Link via place_hierarchy (admin_parent, capital_of relationships)
  </text>
  
  <!-- Legend -->
  <rect x="30" y="625" width="1040" height="130" rx="12" fill="#f8fafc" stroke="#e2e8f0" stroke-width="1" filter="url(#shadow)"/>
  <text x="50" y="655" font-family="Inter, system-ui, sans-serif" font-size="13" font-weight="700" fill="#0f172a">Data Sources Legend</text>
  
  <rect x="50" y="672" width="18" height="18" rx="4" fill="#f97316"/>
  <text x="78" y="686" font-family="Inter, system-ui, sans-serif" font-size="11" fill="#475569"><tspan font-weight="600">REST Countries:</tspan> 250 countries, capitals, flags, translations, ISO codes, currencies, timezones</text>
  
  <rect x="50" y="702" width="18" height="18" rx="4" fill="#22c55e"/>
  <text x="78" y="716" font-family="Inter, system-ui, sans-serif" font-size="11" fill="#475569"><tspan font-weight="600">Wikidata SPARQL:</tspan> ~4,000 ADM1 regions, ~40,000 ADM2 districts, ~100,000 cities with hierarchies</text>
  
  <rect x="50" y="732" width="18" height="18" rx="4" fill="#6366f1"/>
  <text x="78" y="746" font-family="Inter, system-ui, sans-serif" font-size="11" fill="#475569"><tspan font-weight="600">OSM Overpass:</tspan> GeoJSON boundary polygons for administrative divisions (linked by Wikidata QID)</text>
</svg>