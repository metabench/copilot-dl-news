# Working Notes – UI Data Explorer

- 2025-11-14 — Session created. Starting with discovery (js-scan for server call sites) before modifying Express routes.
- 2025-11-14 — Kicking off the URL table subclass refactor so both the CLI renderer and Express server stay in sync. Plan: promote the existing column/row builders into a dedicated `UrlListingTableControl`, update the renderer + server + Puppeteer scripts to import the shared helper, and keep pagination tests green via the pager snapshot harness.
- 2025-11-14 — `js-scan --export-usage createUrlTableServer` reports only the defining module, confirming the function is primarily consumed via direct requires instead of named imports across many files (low-risk rename).
- 2025-11-14 — Cross-check via grep reveals `scripts/ui/puppeteer-console.js` requires the server, so the rename will need to update that dependency plus the npm script entry.
- 2025-11-14 — Multi-view sketch: `/urls` retains the existing paged listing; `/domains` pulls ~40 hosts from `selectRecentDomains` and augments each with total article + fetch counts (via `domainSummary.js`) so we can show "window vs lifetime" metrics; `/crawls` uses `listRecentCrawls` with duration badges; `/errors` surfaces the last 200 `errors` rows (kind/code/message) without exposing HTML bodies. All routes continue to use `renderHtml` plus a shared nav bar so the UI stays read-only and consistent.
- 2025-11-14 — Implemented `src/ui/server/dataExplorerServer.js`, iterating over `DATA_VIEWS` so each route renders via the shared pipeline. Added helpers for badges/durations/counts, reused the renderer’s meta cards, and introduced nav links so `/urls`, `/domains`, `/crawls`, and `/errors` live under one Express instance. Package scripts + Puppeteer helper now target the renamed entry point.
- 2025-11-14 — Extended `render-url-table.js` with an optional primary nav plus styling so the CLI-rendered HTML remains unchanged while the server can inject tab-like links. Smoke-tested the server module with `node -e "require('./src/ui/server/dataExplorerServer.js')"` to confirm it loads after the rename.
- 2025-11-14 — Captured `DATA_EXPLORER_PLANNING.md`, a comprehensive plan covering navigation model, per-view blueprints (URL detail w/ downloads, domain drill-downs, crawl timelines, queue/storage dashboards), proposed jsgui3 controls (Sparkline, Timeline, Badge, CardGrid), and Express routing strategy. Emphasized clickable URL rows leading to descending download histories and use of server-rendered SVG for timelines/sparklines.
 - 2025-11-14 — Implemented `/urls/:id` route and a new `SparklineControl` under `src/ui/controls/` for in-page sparklines. Basic download history table and a 24h hourly sparkline appear in the meta grid; still need to add breadcrumb/back-link preservation and tests.
- 2025-11-14 — Expanded the planning doc with a dedicated Drilldown Specifications section covering every stack (URLs → downloads → fetch metadata, domains → host detail, crawls → events, errors → case detail, queues/storage/gazetteer). Added a Modular Implementation strategy outlining router/service layering, control reuse, breadcrumbs, and testing patterns to keep the Express + jsgui setup DRY.
- 2025-11-14 — Added a Data Structures & UI Surfaces table summarizing each dataset (URLs, fetch history, articles, domains, crawls, errors, queues, storage/compression, gazetteer, telemetry) along with the planned views and controls (tables, card grids, sparklines, SVG charts). Provides a quick reference for future drilldown implementations and ensures coverage remains DRY.
- 2025-11-14 — Clarified the planning doc: added a document map for quick orientation, standardized section numbering (especially the Drilldown stacks), and introduced a short description explaining how the drilldown hierarchy should be read so future contributors don’t get lost.
- 2025-11-14 — Authored `AGG_STATS_PERF_PLAN.md`, detailing the aggregate stat inventory, benchmarking harness, cache table (`ui_cached_metrics`), background worker plan, and UI freshness indicators so we can research which stats must be precomputed and surface their generated timestamps.
- 2025-11-14 — Implemented the first cut of `scripts/perf/ui-aggregates-bench.js` (Node + `better-sqlite3`). The harness loads the production query helpers, times each stat across configurable iterations, emits JSON/tabular summaries, and supports snapshot DB selection plus `--list` discovery so we can start benchmarking URL/domain/queue/gazetteer aggregates immediately.
- 2025-11-14 — Expanded the Next Steps inside `AGG_STATS_PERF_PLAN.md` so each item now lists concrete actions (locking thresholds + snapshot specs, running the first baseline benchmark, deciding on the aggregate worker deployment, and propagating the decision into `DATA_EXPLORER_PLANNING.md`).
- 2025-11-14 — Added `data/perf-snapshots/README.md` documenting the mini/baseline/stress datasets (row targets, creation steps, harness invocation) and updated the plan with explicit pass/fail enforcement rules.
- 2025-11-14 — Seeded `data/perf-snapshots/baseline/news.db` (copied from the current `news.db`) and captured the first benchmark outputs (`aggregate-perf-report.json` + `.md`). URLs/Gazetteer stats have real timings; domain/queue/crawl stats fail because the snapshot lacks those tables/columns, so the follow-up is to refresh the export.
- 2025-11-14 — Decided to run the aggregate worker as an external long-lived service with cadences defined in `config/uiMetrics.json` and documented that architecture in `AGG_STATS_PERF_PLAN.md` + `DATA_EXPLORER_PLANNING.md` (new checklist item + metricsService bullet).
- 2025-11-14 — Built the metrics cache stack: added `ui_cached_metrics` schema/migration, implemented `metricsService` with stat registry + cache helpers, drafted `scripts/ui/run-aggregate-worker.js` (configurable cadences via `config/uiMetrics.example.json`), and updated the `/domains` route to prefer cached host snapshots (falling back to live queries with inline freshness metadata when cache missing).
- 2025-11-14 — Extended `/urls` view to consume cached `urls.total_count`, including subtitle freshness text + meta metrics payload so pagination can avoid re-count queries when the worker is healthy.
- 2025-11-14 — Added `metricsService` Jest coverage (`src/ui/server/services/__tests__/metricsService.test.js`) covering cache refresh, stale detection, and unknown-stat errors; wired the new test into the `test:by-path` runner.
- 2025-11-14 — Refreshed `data/perf-snapshots/baseline/news.db` from the latest `news.db` and re-ran `scripts/perf/ui-aggregates-bench.js --snapshot baseline` (25 iterations). Updated `aggregate-perf-report.{json,md}` with the new timings plus schema gaps that still block the domain/queue/crawl stats.
- 2025-11-14 — Applied `add_ui_cached_metrics_table.sql` to `data/news.db` and executed `scripts/ui/run-aggregate-worker.js --once` so `urls.total_count`, `storage.total_bytes`, and `errors.daily_host_histogram` now populate `ui_cached_metrics` (domains stat still fails until the snapshot ships with `articles`).
- 2025-11-14 — Landed SuperTest coverage for `/urls/:id`, exercising sparkline output, table markup, redirect helper, and error codes via an in-memory better-sqlite3 fixture.
- 2025-11-14 — Implemented `/domains/:host` drilldowns plus host breadcrumbs: linked the URL listing host column to the new route, added domain summary cards (unique URLs, article/fetch totals, first/last seen), hourly sparklines, and download tables that deep-link back to `/urls/:id`.
- 2025-11-14 — Fixed stray braces introduced near the domain snapshot helpers in `src/ui/server/dataExplorerServer.js`, extracted `buildUrlMeta` into a proper top-level helper, and ensured every view passes the normalized client bundle path before rendering. Verified syntax via `node --check src/ui/server/dataExplorerServer.js`; noting separately that requiring the module currently surfaces an unrelated `buildIndexCell` reference issue inside `render-url-table.js`.
- 2025-11-14 — Found the silent Jest run was due to `scripts/jest_careful_runner.mjs` spawning `npx` (missing on Windows via `spawnSync`). Updated the script to invoke the local `jest/bin/jest.js` through `process.execPath`, propagate exit codes, and force color output so `npm run test:by-path` now streams the failing test details again.
- 2025-11-14 — `/urls/:id` tests started 500-ing because `src/db/sqlite/v1/queries/ui/urlDetails.js` never exported `selectUrlById/selectFetchHistory` and its cached `fetchFileInfo` statement referenced the newer `content_encoding` column unconditionally. Exported the helpers, introduced a schema-aware projection that emits `NULL AS contentEncoding` when the column is absent, and aliased the row payload to camelCase so future consumers don’t need to read snake_case keys.
- 2025-11-14 — `renderHtml` left the `<h1>` + subtitle blank because `jsgui3-html` ignores the `{ text }` ctor arg on heading/paragraph controls. Swapped to `StringControl` nodes for both title + subtitle so the “Last N fetches” text actually renders, unblocking the `/urls/:id` regression test after `npm run test:by-path -- tests/ui/server/dataExplorerServer.test.js`.
- 2025-11-14 — Discovered `/urls` started 500-ing in manual runs: pagination setup referenced a non-existent `buildUrlSummarySubtitle` helper when composing the subtitle. Implemented the helper directly inside `dataExplorerServer.js` so it emits a friendly “Rows X-Y of Z • Page A of B • cached metric as of …” string, keeping the cached metric metadata visible without crashing.
- 2025-11-14 — Host column links were rendering the hostname twice (`example.comexample.com`) because `TableCellControl` passed `content` through to `jsgui3-html` and then re-added the same control manually, causing duplicate anchor children whenever a cell used `href`. Updated the control to strip `content`/`text`/`control` before calling `super` so we only add the link once; manual table renders and `/urls` now show a single host string per row.
- 2025-11-14 — Added `src/ui/controls/UrlListingTable.js`, a subclass that owns the shared URL column definitions, row-mapping helpers, and date/status formatting. Swapped the CLI renderer, Express server, Puppeteer artifact script, and pager snapshot harness over to the shared helper so they no longer copy/paste the column + row builders.
- 2025-11-14 — `npm run test:by-path -- tests/ui/server/dataExplorerServer.test.js` ✅ (baseline mapping package still logs the stale-data warning, but the URL + domain routes continue to pass).
- 2025-11-14 — Pattern implementation plan: ❶ add `navContext` helpers (`buildGlobalNav`, `buildBreadcrumbs`, `deriveBackLink`) so every view/detail route renders consistent navigation affordances, ❷ introduce dataset-specific table controls (`DomainSummaryTable`, `DomainDownloadsTable`, `CrawlJobsTable`, `ErrorLogTable`) and move their row builders out of the server, ❸ split DB access into service modules (`urlViewService`, `domainViewService`, etc.) that return view models consumed by the Express handlers, ❹ extend docs/tests once the refactor lands.
- 2025-11-14 — `/crawls` view now consumes `CrawlJobsTable` builders, reusing the shared duration/status formatting and letting us delete the bespoke badge/duration helpers from the server module.
- 2025-11-14 — `/errors` list switched to `ErrorLogTable` rows/columns with automatic host drill-down links plus `buildBackLinkTarget` propagation so breadcrumb/back navigation stays consistent across datasets.
- 2025-11-14 — Added `ConfigMatrixControl` as a property-grid style control with collapsible sections, validation badges, and `data-editor-slot` markers so we can wire up Visual Studio-esque editors later. Focused the initial sections on crawl-runner settings so crawl planners can scan concurrency, budgets, and seed definitions without diffing JSON.
- 2025-11-14 — Created `CrawlBehaviorPanelControl`, a behavior-focused card deck that turns throttle/budget/robots policies into readable summaries (scope, mode, cues, derived config). Behaviors share the same badge vocabulary as the tables so upcoming dashboards can mix them.
- 2025-11-14 — Introduced lightweight HTML checking scripts under `src/ui/controls/checks/`, currently `ConfigMatrixControl.check.js` and `CrawlBehaviorPanel.check.js`, to render controls directly from repo config data (`node src/ui/controls/checks/<name>.check.js`). These scripts act as quick sanity checks alongside Jest and live next to their controls per the new doc guidance.
- 2025-11-14 — Noted in plan: follow-up will add editable subclasses (property editors + behavior toggles) that plug into the existing `data-editor-slot` anchors once orchestration is approved; leaving the controls read-only for now per request.
