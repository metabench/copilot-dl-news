# Working Notes — UI Data Explorer Production Tests

- 2025-11-20 — Session spun up to extend Data Explorer coverage using production-sized SQLite snapshots. Commands will prefer bilingual `js-scan/js-edit` invocations with `--json --ai-mode` and will be logged here as they run.
- 2025-11-20 — Captured the session plan and linked it from `SESSIONS_HUB.md` so future agents can follow the production-testing mandate.
- 2025-11-20 — Ran `node tools/dev/js-scan.js --search renderDomainSummaryView --json --ai-mode` to map the domain summary renderer before touching the server routes (token `js--0y1h5g-ana-66d6`).
- 2025-11-20 — Probed `/urls`, `/domains`, `/crawls`, `/errors` via `node -e "const path=require('path'); const request=require('supertest'); const {createDataExplorerServer}=require('./src/ui/server/dataExplorerServer'); const dbPath=path.resolve('data/news.db'); const server=createDataExplorerServer({dbPath,pageSize:20}); (async () => { const routes=['/urls','/domains','/crawls','/errors']; for (const route of routes) { try { const res=await request(server.app).get(route); console.log(route,res.status,res.text.slice(0,80).replace(/\\n/g,' ')); } catch(err){ console.error('route',route,'failed',err); } } server.close(); })();"` — `/domains` and `/crawls` both 500 due to `no such column: url` in `selectRecentDomains` and `no such column: j.url` inside `listRecentCrawls` when pointed at `data/news.db`.
- 2025-11-20 — Introduced `tableHasColumn` in `src/db/sqlite/v1/queries/helpers.js` and rewrote the recent domain + crawl queries to fall back to `url_id` joins whenever `url` columns are absent so production snapshots stay compatible with older schemas.
- 2025-11-20 — `node tools/dev/js-scan.js --what-imports src/db/sqlite/v1/queries/ui/recentDomains.js --json --ai-mode` confirmed only the new Data Explorer + metrics service depend on the recent domains query, keeping the fix surface small.
- 2025-11-20 — `node tools/dev/js-scan.js --what-imports src/db/sqlite/v1/queries/ui/crawls.js --json --ai-mode` shows only the Data Explorer and deprecated UI import the crawl summary helper, so schema guards there will cover all consumers.
- 2025-11-20 — After landing schema-aware query updates, ran `npm run test:by-path -- tests/ui/server/dataExplorerServer.test.js` to ensure the in-memory coverage still passes (6 tests ✅).
- 2025-11-20 — Verified the production snapshot routes again with `node -e "const path=require('path'); const request=require('supertest'); const {createDataExplorerServer}=require('./src/ui/server/dataExplorerServer'); const dbPath=path.resolve('data/news.db'); const server=createDataExplorerServer({dbPath,pageSize:20}); (async () => { const routes=['/urls','/domains','/crawls','/errors']; for (const route of routes) { try { const res=await request(server.app).get(route); console.log(route,res.status,res.text.slice(0,80).replace(/\\n/g,' ')); } catch(err){ console.error('route',route,'failed',err); } } server.close(); })();"` — all four endpoints now return HTTP 200 with HTML payloads.
- 2025-11-20 — Added `tests/ui/server/dataExplorerServer.production.test.js` to hit `/urls`, `/domains`, `/crawls`, `/errors`, and a `/domains/:host` drilldown against `data/news.db`, skipping automatically when the snapshot is missing.
- 2025-11-20 — `npm run test:by-path -- tests/ui/server/dataExplorerServer.production.test.js` now covers five production-data assertions (PASS, 2.7s). Running both suites together via `npm run test:by-path -- tests/ui/server/dataExplorerServer.test.js tests/ui/server/dataExplorerServer.production.test.js` also passes (11 tests) though Jest emits the usual worker teardown warning thanks to `better-sqlite3` keeping handles alive.
- 2025-11-20 — `node tools/dev/js-scan.js --search buildDisplayRows --json --ai-mode` provided the context needed to expose URL ids and detail links inside `render-url-table.js` before editing.
- 2025-11-20 — Verified the standalone renderer still works by running `node src/ui/render-url-table.js --limit 5 --output tmp/url-table.html` (writes sample HTML with the new ID column + detail links).
