<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>News Crawler UI</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; color: #222; }
    header { display: flex; align-items: baseline; gap: 12px; }
    form { display: grid; grid-template-columns: repeat(4, minmax(180px, 1fr)); gap: 8px 12px; margin: 12px 0; }
    label { display: flex; flex-direction: column; font-size: 12px; color: #555; }
    input[type="text"], input[type="number"] { padding: 6px; font-size: 14px; }
    .row { grid-column: 1 / -1; display: flex; gap: 8px; align-items: center; }
    .btn { padding: 8px 12px; font-size: 14px; cursor: pointer; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    #status { margin: 8px 0; }
    #log { background: #0d1117; color: #c9d1d9; padding: 12px; height: 360px; overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; border-radius: 6px; }
    .stats { display: flex; gap: 16px; font-size: 14px; color: #444; }
  </style>
</head>
<body>
  <header>
    <h2>News Crawler</h2>
    <small>Express UI</small>
  </header>

  <section>
    <form id="crawlForm">
      <label>Start URL
        <input type="text" name="startUrl" value="https://www.theguardian.com/uk" />
      </label>
      <label>Depth
        <input type="number" name="depth" value="1" min="0" />
      </label>
      <label>Max pages
        <input type="number" name="maxPages" value="2" min="1" />
      </label>
      <label>Max age (e.g., 6h)
        <input type="text" name="maxAge" placeholder="e.g., 30s, 10m, 2h, 1d" />
      </label>
      <label>Concurrency
        <input type="number" name="concurrency" value="2" min="1" />
      </label>
      <label>Max queue
        <input type="number" name="maxQueue" value="5000" min="100" />
      </label>
      <label>DB path (optional)
        <input type="text" name="dbPath" placeholder="./data/news.db" />
      </label>
      <div class="row">
        <label><input type="checkbox" name="noDb" /> Disable DB</label>
        <button class="btn" id="startBtn" type="submit">Start Crawl</button>
        <button class="btn" id="stopBtn" type="button">Stop</button>
      </div>
    </form>
    <div id="status" class="stats">
      <div>Running: <span id="running">false</span></div>
      <div>PID: <span id="pid">-</span></div>
      <div>Visited: <span id="visited">0</span></div>
      <div>Downloaded: <span id="downloaded">0</span></div>
      <div>Found: <span id="found">0</span></div>
      <div>Saved: <span id="saved">0</span></div>
    </div>
  </section>

  <section>
    <div id="log"></div>
  </section>

  <script>
    const statusEl = {
      running: document.getElementById('running'),
      pid: document.getElementById('pid'),
      visited: document.getElementById('visited'),
      downloaded: document.getElementById('downloaded'),
      found: document.getElementById('found'),
      saved: document.getElementById('saved'),
    };

    let es = null;

    function appendLog(line, stream) {
      const el = document.getElementById('log');
      const span = document.createElement('div');
      span.textContent = line.replace(/\n$/, '');
      if (stream === 'stderr') span.style.color = '#ff7b72';
      el.appendChild(span);
      el.scrollTop = el.scrollHeight;
    }

    async function refreshStatus() {
      try {
        const r = await fetch('/api/status');
        const s = await r.json();
        statusEl.running.textContent = s.running;
        statusEl.pid.textContent = s.pid || '-';
        document.getElementById('startBtn').disabled = s.running;
        document.getElementById('stopBtn').disabled = !s.running;
      } catch {}
    }

    function openEvents() {
      if (es) es.close();
      es = new EventSource('/events');
      es.addEventListener('log', (e) => {
        const msg = JSON.parse(e.data);
        appendLog(msg.line, msg.stream);
      });
      es.addEventListener('progress', (e) => {
        const p = JSON.parse(e.data);
        statusEl.visited.textContent = p.visited;
        statusEl.downloaded.textContent = p.downloaded;
        statusEl.found.textContent = p.found;
        statusEl.saved.textContent = p.saved;
      });
      es.addEventListener('done', async (e) => {
        const info = JSON.parse(e.data);
        appendLog(`Process finished (code=${info.code}, signal=${info.signal})`, 'stdout');
        await refreshStatus();
      });
      es.addEventListener('error', (e) => {
        try { appendLog(JSON.parse(e.data).message, 'stderr'); } catch {}
      });
    }

    document.getElementById('crawlForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const form = ev.currentTarget;
      const body = Object.fromEntries(new FormData(form).entries());
      // Normalize types
      body.depth = body.depth ? Number(body.depth) : undefined;
      body.maxPages = body.maxPages ? Number(body.maxPages) : undefined;
      body.concurrency = body.concurrency ? Number(body.concurrency) : undefined;
      body.maxQueue = body.maxQueue ? Number(body.maxQueue) : undefined;
      body.noDb = form.noDb.checked;

      try {
        const r = await fetch('/api/crawl', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        if (!r.ok) {
          const err = await r.json().catch(() => ({}));
          appendLog(`Failed to start: ${err.error || r.statusText}`, 'stderr');
          return;
        }
        const started = await r.json();
        appendLog(`Started crawler PID=${started.pid} args=${started.args.join(' ')}`, 'stdout');
        await refreshStatus();
      } catch (e) {
        appendLog(`Error starting: ${e.message}`, 'stderr');
      }
    });

    document.getElementById('stopBtn').addEventListener('click', async () => {
      try {
        const r = await fetch('/api/stop', { method: 'POST' });
        const s = await r.json();
        if (s.stopped) appendLog('Stop signal sent', 'stdout');
        await refreshStatus();
      } catch (e) {
        appendLog(`Error stopping: ${e.message}`, 'stderr');
      }
    });

    openEvents();
    refreshStatus();
  </script>
</body>
</html>
