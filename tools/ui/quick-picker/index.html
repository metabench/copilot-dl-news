<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Quick Picker</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: #1e1e1e;
      color: #cccccc;
      margin: 0;
      padding: 10px;
      overflow: hidden;
      border: 1px solid #333;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      height: 95vh;
    }
    
    h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 14px;
      color: #007acc;
      text-transform: uppercase;
      letter-spacing: 1px;
      -webkit-app-region: drag; /* Allow dragging by header */
      padding-bottom: 5px;
      border-bottom: 1px solid #333;
    }

    #options-list {
      list-style: none;
      padding: 0;
      margin: 0;
      overflow-y: auto;
      flex-grow: 1;
    }

    .option-item {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 3px;
      margin-bottom: 2px;
      transition: background-color 0.1s;
      font-size: 13px;
    }

    .option-item:hover {
      background-color: #2a2d2e;
    }

    .option-item.selected {
      background-color: #094771;
      color: white;
    }

    .option-item .description {
      display: block;
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }

    .option-item .icon {
      margin-right: 8px;
      font-size: 14px;
    }
    
    .option-item.selected .description {
      color: #ccc;
    }

    #footer {
      margin-top: 10px;
      font-size: 11px;
      color: #666;
      text-align: right;
    }
  </style>
</head>
<body>
  <h3>Select an Option</h3>
  <ul id="options-list"></ul>
  <div id="footer">Double-click to select ‚Ä¢ Esc to cancel</div>

  <script>
    const { ipcRenderer } = require('electron');

    const list = document.getElementById('options-list');
    const footer = document.getElementById('footer');
    const footerDefault = 'Double-click to select ‚Ä¢ Esc to cancel';
    let footerTimer = null;
    let currentOptions = [];
    let selectedIndex = -1;

    ipcRenderer.on('set-options', (event, options) => {
      currentOptions = options;
      renderOptions();
    });

    function renderOptions() {
      list.innerHTML = '';
      currentOptions.forEach((opt, index) => {
        const li = document.createElement('li');
        li.className = 'option-item';
        li.dataset.index = index;
        
        // Handle string options or object options { label, description, value }
        const label = typeof opt === 'string' ? opt : (opt.label || opt.value);
        const description = typeof opt === 'object' ? opt.description : null;
        const phase = typeof opt === 'object' ? opt.phase : null;
        const phaseIcon = {
          plan: 'üß≠',
          explore: 'üîç',
          design: 'üß≠',
          implement: 'üõ†Ô∏è',
          test: 'üß™',
          validate: '‚úÖ',
          fix: 'üõ°Ô∏è'
        }[phase];
        const icon = typeof opt === 'object' ? (opt.icon || opt.emoji || phaseIcon) : null;

        let html = '';
        if (icon) {
          html += `<span class="icon">${icon}</span>`;
        }
        html += `<span class="label">${label}</span>`;
        if (description) {
          html += `<span class="description">${description}</span>`;
        }
        li.innerHTML = html;

        li.addEventListener('click', () => {
          selectItem(index);
        });

        li.addEventListener('dblclick', () => {
          confirmSelection(index);
        });

        li.addEventListener('contextmenu', (event) => {
          event.preventDefault();
          selectItem(index);
          ipcRenderer.send('context-menu', { option: opt });
        });

        list.appendChild(li);
      });
      
      // Select first by default
      if (currentOptions.length > 0) {
        selectItem(0);
      }
    }

    ipcRenderer.on('context-action', (event, payload) => {
      if (!payload || !payload.option) return;
      const option = payload.option;
      const action = payload.action;
      const label = option.label || option.value;
      const actionLabel = {
        explore: 'üîç Explore',
        test: 'üß™ Test',
        implement: 'üõ†Ô∏è Implement',
        fix: 'üõ°Ô∏è Fix'
      }[action] || action;
      setFooter(`${actionLabel}: ${label}`);
    });

    function setFooter(message) {
      footer.textContent = message;
      if (footerTimer) {
        clearTimeout(footerTimer);
      }
      footerTimer = setTimeout(() => {
        footer.textContent = footerDefault;
      }, 3000);
    }

    function selectItem(index) {
      if (selectedIndex !== -1) {
        list.children[selectedIndex].classList.remove('selected');
      }
      selectedIndex = index;
      if (selectedIndex !== -1) {
        const el = list.children[selectedIndex];
        el.classList.add('selected');
        el.scrollIntoView({ block: 'nearest' });
      }
    }

    function confirmSelection(index) {
      if (index >= 0 && index < currentOptions.length) {
        const opt = currentOptions[index];
        const value = typeof opt === 'object' ? (opt.value || opt.label) : opt;
        ipcRenderer.send('selection-made', { selection: value, option: opt, phase: opt.phase });
      }
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectItem(Math.min(selectedIndex + 1, currentOptions.length - 1));
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectItem(Math.max(selectedIndex - 1, 0));
      } else if (e.key === 'Enter') {
        confirmSelection(selectedIndex);
      } else if (e.key === 'Escape') {
        ipcRenderer.send('cancel');
      }
    });
  </script>
</body>
</html>
