# Test Analysis Tools

Simple, focused tools for extracting precise information from test logs without PowerShell complexity.

## Quick Reference

```bash
# Get latest log path
node tests/get-latest-log.js              # Latest log (any suite)
node tests/get-latest-log.js unit         # Latest unit test log

# Get failing tests
node tests/get-failing-tests.js           # List all failing tests + last message
node tests/get-failing-tests.js --count   # Count failing tests
node tests/get-failing-tests.js --simple  # Just file paths
node tests/get-failing-tests.js --history # Show last 5 runs (latest suite)
node tests/get-failing-tests.js --history --test crawl.e2e # Track one test across runs

# Get summary
node tests/get-test-summary.js            # Human-readable summary
node tests/get-test-summary.js --json     # JSON output
node tests/get-test-summary.js --compact  # One-line status snapshot

# Get slow tests
node tests/get-slow-tests.js              # Tests >5s
node tests/get-slow-tests.js 10           # Tests >10s
node tests/get-slow-tests.js --count      # Count slow tests

# Track baseline failures vs fixes
node tests/tests-review.js                # Review baseline failures and fixes
node tests/tests-review.js --json         # Machine-readable report
```

## Tools

### 1. `get-latest-log.js` - Find Latest Test Log

Returns the absolute path to the most recent test log file.

**Usage:**
```bash
node tests/get-latest-log.js              # Latest log (any suite)
node tests/get-latest-log.js unit         # Latest unit test log
node tests/get-latest-log.js e2e          # Latest E2E test log
node tests/get-latest-log.js integration  # Latest integration test log
node tests/get-latest-log.js ALL          # Latest full test suite log
```

**Output:**
```
C:\Users\james\Documents\repos\copilot-dl-news\testlogs\2025-10-10T22-05-32-514Z_ALL.log
```

**Use Case:** Get log path for reading with `read_file` tool (no PowerShell needed).

---

### 2. `get-failing-tests.js` - Extract Failing Tests

Lists the tests that failed in the latest log (with the most recent failure message) and can optionally show historical status across earlier runs.

**Usage:**
```bash
node tests/get-failing-tests.js           # All failing tests from latest log
node tests/get-failing-tests.js unit      # Failing tests from latest unit log
node tests/get-failing-tests.js --count   # Just count failing tests
node tests/get-failing-tests.js --simple  # Just test file paths (no details)
node tests/get-failing-tests.js --history          # Last 5 runs (latest suite)
node tests/get-failing-tests.js --history --logs 8 # Last 8 runs
node tests/get-failing-tests.js --history --test gazetteer.country.performance
                                                 # Track a specific test across runs
```

**Output (detailed mode):**
```
Log: 2025-10-10T21-56-42-580Z_ALL.log (2025-10-10 21:56:42.580Z)

❌ Found 3 test file(s) with failures:

1. src\ui\express\__tests__\analyze.api.test.js
   Runtime: 4.23s | Failed: 2/8 tests
   Latest failure: Expected 200 but received 500 (response body missing telemetry payload)

2. src\crawler\__tests__\sitemap.test.js
   Runtime: 1.45s | Failed: 1/5 tests
   Latest failure: Sitemap should include canonical URL for https://example.com/news

3. src\db\__tests__\migration.test.js
   Runtime: 3.12s | Failed: 3/10 tests
   Latest failure: Expected column crawl_jobs.is_active to exist before migration
```

**Output (simple mode):**
```
src\ui\express\__tests__\analyze.api.test.js
src\crawler\__tests__\sitemap.test.js
src\db\__tests__\migration.test.js
```

**Output (count mode):**
```
3
```

**Exit Code:** 0 if no failures, 1 if failures exist.

**Use Case:** Quickly identify what needs fixing without reading full log or rerunning the suite—the failure message comes from `test-failure-summary.json` generated by the reporter.

**History Mode:**

When `--history` (optionally with `--logs N`) is provided, the tool scans recent log files for failures. Combine with `--test <pattern>` to confirm when a specific test last failed or passed. The reporter now stores a per-run snapshot beside each log (`testlogs/<timestamp>_<suite>.failures.json`), so historical lookups surface the original failure messages when available.

---

### 3. `get-test-summary.js` - Quick Status Overview

Extracts key metrics from the latest test log and layers in guardrails to keep results trustworthy.

- Automatically ignores non-timestamped logs (for example `imported_*`) when picking the "latest" run.
- Treats `_ALL.log` files with fewer than 50 suites as *suspect* and falls back to the last real full-suite run when needed.
- Cross-checks every baseline failure against all newer logs so tests that have since passed are removed from the failing list and reported under **Fixed since baseline**.
- Flags quarantined tests (`tests/broken/**`) with a `[broken-suite]` tag and summarizes the broken count so agents know not to re-run them.

**Usage:**
```bash
node tests/get-test-summary.js              # Summary from latest log
node tests/get-test-summary.js unit         # Summary from latest unit log
node tests/get-test-summary.js --json       # Output as JSON
node tests/get-test-summary.js --compact    # One-line console output
```

**Output (human-readable):**
```
📊 Test Summary (ALL)
   Timestamp: 2025-10-10T22:05:32.514Z
   Runtime: 9.39s

   Files:  13 test files
   Tests:  129 total (129 passed, 0 failed)
   Slow:   4 files >5s, 0 files >10s

   ✅ All tests passing
```

**Output (compact):**
```
suite=all | at=2025-10-17 21:00:51.491Z | runtime=92.57s | files=193 | tests=1245/1274 | fail=29 | slow>11 | activeFailing=11 | resolved=6 | broken=1 | failures=tests/e2e-features/geography-crawl/startup-and-telemetry.test.js, …
```

**Output (JSON):**
```
{
   "timestamp": "2025-10-17T21:00:51.491Z",
   "suite": "all",
   "totalRuntime": 92.57,
   "totalFiles": 193,
   "totalTests": 1274,
   "passedTests": 1245,
   "failedTests": 29,
   "slowTests": 11,
   "verySlowTests": 9,
   "failingFiles": [
      "tests\\e2e-features\\geography-crawl\\startup-and-telemetry.test.js",
      "…"
   ],
   "resolvedSinceBaseline": [
      {
         "testPath": "src\\crawler\\__tests__\\CountryHubPlanner.test.js",
         "resolvedInLog": "2025-10-17T21-26-59-527Z_ALL.log",
         "resolvedIsoTimestamp": "2025-10-17T21:26:59.527Z",
         "suite": "ALL"
      }
   ],
   "resolvedCount": 6,
   "activeFailingCount": 11,
   "brokenFailingFiles": [
      "tests\\e2e-features\\ui-controls\\start-button.test.js"
   ],
   "brokenFailingCount": 1
}
```

**Exit Code:** 0 if all tests pass, 1 if any failures.

**Use Case:** Quick status check before starting work, or verifying fix results while distinguishing between unresolved failures, newly fixed tests, and quarantined tests.

---

### 4. `get-slow-tests.js` - Find Performance Bottlenecks

Lists tests exceeding a runtime threshold.

**Usage:**
```bash
node tests/get-slow-tests.js              # Tests >5s from latest log
node tests/get-slow-tests.js 10           # Tests >10s from latest log
node tests/get-slow-tests.js 3 unit       # Tests >3s from latest unit log
node tests/get-slow-tests.js --count      # Just count slow tests
```

**Output:**
```
⏱️  Found 4 test(s) exceeding 5s:

1. ✅ 5.61s - src\db\__tests__\dbAccess.test.js
2. ✅ 5.47s - src\tools\__tests__\maintain-db.test.js
3. ✅ 5.28s - src\crawler\gazetteer\__tests__\StagedGazetteerCoordinator.planner.test.js
4. ✅ 5.11s - src\utils\__tests__\compressionBuckets.test.js
```

**Use Case:** Identify tests that might benefit from optimization or timeout guards.

---

### 5. `tests-review.js` - Baseline Failure Tracker

Analyzes historical logs to understand the status of failing tests from the most recent full suite run (`ALL`). It highlights which failures have already been fixed, which are still failing, and which have not been re-run since the baseline.

**Usage:**
```bash
node tests/tests-review.js           # Human-readable report
node tests/tests-review.js --json    # JSON output for scripting
npm run tests:review                 # Shortcut via package script
```

**Output (human-readable):**
```
════════════════════════════════════════════════════════════════════════════════
🧪 TESTS REVIEW
════════════════════════════════════════════════════════════════════════════════

Baseline log : 2025-10-12T09-07-19_ALL.log
Captured     : 3 failing test file(s)

✅ Fixed since baseline (1)
────────────────────────────────────────────────────────────────────────────────
   • src/ui/express/__tests__/recent-domains.api.test.js
      Baseline : 2025-10-12 09:07:19 (fail 1/4)
      Fixed on : 2025-10-17 21:37:46 via suite all (runtime 0.88s)

❌ Still failing (1)
────────────────────────────────────────────────────────────────────────────────
   • tests/e2e-features/geography-crawl/startup-and-telemetry.test.js
      Baseline : 2025-10-12 09:07:19 (fail 1/1)
      Last fail: 2025-10-17 21:55:12 via suite all

🕒 Awaiting retest (1)
────────────────────────────────────────────────────────────────────────────────
   • src/crawler/__tests__/phase-123-integration.test.js
      Last seen: 2025-10-12 09:07:19 (baseline failure)

════════════════════════════════════════════════════════════════════════════════
```

**Use Case:** Quickly confirm which baseline failures still need attention without re-running the entire suite.

---

## Integration with Testing Workflow

These tools are designed to be used in the testing workflow documented in `docs/TESTING_REVIEW_AND_IMPROVEMENT_GUIDE.md`.

**Typical AI Agent Workflow:**

1. **Check current status** (5 seconds):
   ```bash
   node tests/get-test-summary.js --compact
   ```

2. **If failures exist, list them** (5 seconds):
   ```bash
   node tests/get-failing-tests.js
   ```

3. **Get log path for detailed reading** (2 seconds):
   ```bash
   node tests/get-latest-log.js
   # Then use read_file tool on the returned path
   ```

4. **After fixing, verify** (5 seconds):
   ```bash
   node tests/get-test-summary.js --compact
   ```

**Total time:** ~17 seconds vs. 30-60+ seconds with PowerShell command chains.

## Design Principles

1. **Single Purpose:** Each tool does one thing well
2. **Simple Output:** Easy to parse, no complex formatting
3. **Fast Execution:** <5 seconds per tool
4. **No Confirmation:** Never triggers PowerShell approval dialogs
5. **Composable:** Tools can be chained via command line
6. **Exit Codes:** Meaningful exit codes for automation

## See Also

- `tests/analyze-test-logs.js` - Comprehensive historical analysis
- `tests/run-tests.js` - Configuration-based test runner
- `docs/TESTING_REVIEW_AND_IMPROVEMENT_GUIDE.md` - Full testing workflow guide
