<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Article URLs</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
      ol { padding-left: 20px; }
      .meta { color: #555; margin-bottom: 12px; }
      a { word-break: break-all; }
      .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
      .muted { color:#666; font-size:12px; }
      .copy { font-size: 12px; margin-left: 6px; }
    </style>
  </head>
  <body>
    <h1>Article URLs</h1>
    <div class="meta" id="meta">Loading…</div>
    <div class="meta row">
      <button id="prev">Prev</button>
      <button id="next">Next</button>
      <label>Page <input id="pageInput" type="number" min="1" style="width:5em" /></label>
      <label>Sort
        <select id="sortDir">
          <option value="desc">Newest first</option>
          <option value="asc">Oldest first</option>
        </select>
      </label>
      <label>Filter <input id="filterInput" type="text" placeholder="type to filter current page" style="width:18em" /></label>
      <span id="pageStats" class="muted"></span>
    </div>
    <ol id="list"></ol>
    <p><a href="/">Back to dashboard</a></p>
    <script>
      let offset = 0;
      const limit = 200;
      let total = 0;
      let count = 0;
      const prevBtn = document.getElementById('prev');
      const nextBtn = document.getElementById('next');
  const pageInput = document.getElementById('pageInput');
  const filterInput = document.getElementById('filterInput');
  const pageStats = document.getElementById('pageStats');
  let currentItems = [];
      function updateButtons() {
        prevBtn.disabled = offset <= 0;
        nextBtn.disabled = offset + count >= total;
      }
      async function load() {
        const dir = document.getElementById('sortDir').value || 'desc';
        const r = await fetch(`/api/urls?limit=${limit}&offset=${offset}&details=1&dir=${encodeURIComponent(dir)}`);
        const j = await r.json();
        total = j.total;
        count = j.count;
        document.getElementById('meta').textContent = `${j.total} URLs total — showing ${j.offset+1}-${Math.min(j.offset + j.count, j.total)}`;
        const list = document.getElementById('list');
        list.innerHTML = '';
        currentItems = Array.isArray(j.items) && j.items.length ? j.items.slice() : (j.urls || []).map(u => ({ url: u, title: null, ts: null }));
        render();
        updateButtons();
      }
      function render() {
        const list = document.getElementById('list');
        list.innerHTML = '';
        const filter = (filterInput.value || '').toLowerCase();
        let shown = 0;
        currentItems.filter(it => !filter || it.url.toLowerCase().includes(filter) || (it.title||'').toLowerCase().includes(filter)).forEach((it) => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = it.url; a.textContent = it.url; a.target = '_blank'; a.rel = 'noopener noreferrer';
          const details = document.createElement('a');
          details.href = `/url?url=${encodeURIComponent(it.url)}`;
          details.textContent = '[details]';
          details.style.marginLeft = '6px';
          const ts = it.ts ? new Date(it.ts).toLocaleString() : null;
          const tsSpan = document.createElement('span');
          tsSpan.className = 'muted';
          tsSpan.textContent = ts ? ` – ${ts}` : '';
          const copyBtn = document.createElement('button');
          copyBtn.className = 'copy';
          copyBtn.textContent = 'Copy';
          copyBtn.title = 'Copy URL to clipboard';
          copyBtn.onclick = async () => {
            try { await navigator.clipboard.writeText(it.url); copyBtn.textContent = 'Copied'; setTimeout(()=> copyBtn.textContent = 'Copy', 1000); } catch (_) {}
          };
          li.appendChild(a);
          li.appendChild(details);
          if (ts) li.appendChild(tsSpan);
          li.appendChild(copyBtn);
          list.appendChild(li);
          shown++;
        });
        pageStats.textContent = `${shown} shown; page ${(offset/limit)+1} of ${Math.max(1, Math.ceil(total/limit))}`;
      }
      load().catch(err => {
        document.getElementById('meta').textContent = 'Failed to load URLs: ' + err.message;
      });
      prevBtn.onclick = () => { const nextOffset = Math.max(0, offset - limit); if (nextOffset !== offset) { offset = nextOffset; load(); } };
      nextBtn.onclick = () => { const nextOffset = Math.min(total, offset + limit); if (nextOffset !== offset) { offset = nextOffset; load(); } };
  document.getElementById('sortDir').onchange = () => { offset = 0; load(); };
      pageInput.onchange = () => {
        const p = Math.max(1, Math.floor(Number(pageInput.value) || 1));
        const nextOffset = Math.min(total, (p - 1) * limit);
        if (nextOffset !== offset) { offset = nextOffset; load(); }
      };
      // Debounce filter typing
      let filterTimer = null;
      filterInput.oninput = () => {
        if (filterTimer) clearTimeout(filterTimer);
        filterTimer = setTimeout(() => { render(); filterTimer = null; }, 120);
      };

      // Keyboard navigation: left/right arrows outside inputs
      document.addEventListener('keydown', (e) => {
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
        if (tag === 'input' || tag === 'textarea') return;
        if (e.key === 'ArrowLeft' && !prevBtn.disabled) { prevBtn.click(); }
        if (e.key === 'ArrowRight' && !nextBtn.disabled) { nextBtn.click(); }
      });
    </script>
  </body>
  </html>
