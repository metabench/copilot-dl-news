<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Queues</title>
  <style>
    :root{--fg:#0f172a;--muted:#64748b;--border:#e5e7eb;--bg:#ffffff;--bg-soft:#f8fafc;--accent:#0ea5e9}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--fg)}
    .container{max-width:1000px;margin:18px auto;padding:0 16px}
    header{display:flex;align-items:baseline;justify-content:space-between;margin:6px 0 12px}
    header h1{margin:0;font-size:20px}
    header nav a{color:var(--muted);text-decoration:none;margin-left:10px}
    header nav a:hover{color:var(--fg);text-decoration:underline}
    .card{background:var(--bg-soft);border:1px solid var(--border);border-radius:10px;padding:10px}
    table{border-collapse:collapse;width:100%;background:#fff;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    th,td{border-bottom:1px solid var(--border);padding:8px 10px;font-size:14px}
    th{color:var(--muted);text-align:left;background:#fcfcfd}
    tr:nth-child(even){background:#fafafa}
    tr:hover{background:#f6f8fa}
    .muted{color:var(--muted)}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;background:#fff;font-size:12px}
    .row{display:flex;gap:8px;align-items:center}
    .warn{color:#b45309}
    .bad{color:#dc2626}
    .ok{color:#16a34a}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  </style>
  <script type="module" src="/assets/global-nav.js"></script>
  </head>
  <body>
  <div class="container">
    <div data-global-nav data-active="queues"></div>
    <header>
      <h1>Queues <span id="job" class="pill mono"></span></h1>
    </header>

    <section class="card">
      <div class="row" style="justify-content:space-between; flex-wrap: wrap; gap:8px">
        <div class="meta">
          <span id="modeLabel">Live queue events</span> (<span id="count">0</span>)
          <span id="persistMeta" class="meta" style="margin-left:8px"></span>
        </div>
        <div class="row" style="gap:8px">
          <label class="meta"><input type="checkbox" id="onlyActive"/> Filter to active job</label>
          <select id="jobSelect" style="min-width:320px"></select>
          <button id="loadBtn">Load events</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>When</th><th>Action</th><th>URL</th><th>Depth</th><th>Host</th><th>Reason</th><th>Queue size</th><th>Job</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="8" class="muted">Waiting for events…</td></tr></tbody>
      </table>
    </section>
  </div>
  <script>
    (function(){
      const tbody = document.getElementById('tbody');
      const countEl = document.getElementById('count');
      const onlyActive = document.getElementById('onlyActive');
  const jobSpan = document.getElementById('job');
  const jobSelect = document.getElementById('jobSelect');
  const loadBtn = document.getElementById('loadBtn');
  const modeLabel = document.getElementById('modeLabel');
  const persistMeta = document.getElementById('persistMeta');
      let activeJob = null;
      let seen = 0;
  let historyMode = false;

      function addRow(ev) {
        const tr = document.createElement('tr');
        const td = (...args)=>{ const td=document.createElement('td'); td.textContent = args[0] ?? ''; return td; };
        const ts = new Date().toLocaleTimeString();
        tr.appendChild(td(ts));
        tr.appendChild(td(ev.action||''));
        tr.appendChild(td(ev.url||''));
        tr.appendChild(td(ev.depth!=null?String(ev.depth):''));
        tr.appendChild(td(ev.host||''));
        tr.appendChild(td(ev.reason||''));
        tr.appendChild(td(ev.queueSize!=null?String(ev.queueSize):''));
        tr.appendChild(td(ev.jobId||''));
        tbody.appendChild(tr);
      }

      function ensureHeader() {
        if (!tbody.firstChild || tbody.firstChild.children.length !== 8) {
          tbody.innerHTML = '';
        }
      }

      async function loadJobs() {
        try {
          const res = await fetch('/api/queues');
          const data = await res.json();
          const items = Array.isArray(data.items) ? data.items : [];
          jobSelect.innerHTML = '';
          const opt0 = document.createElement('option'); opt0.value = ''; opt0.textContent = items.length ? '— Select a job —' : 'No jobs'; jobSelect.appendChild(opt0);
          for (const j of items) {
            const o = document.createElement('option');
            const label = `${j.id} — ${j.url||''} (${j.status||'unknown'}, ${j.events||0} events)`;
            o.value = j.id; o.textContent = label; o.dataset.events = String(j.events||0);
            o.dataset.startedAt = j.startedAt || ''; o.dataset.endedAt = j.endedAt || ''; o.dataset.status = j.status||'';
            jobSelect.appendChild(o);
          }
        } catch (_) {}
      }

      function renderPersistMeta(opt) {
        if (!opt) { persistMeta.textContent = ''; return; }
        const parts = [];
        if (opt.dataset.status) parts.push(`status=${opt.dataset.status}`);
        if (opt.dataset.startedAt) parts.push(`started=${opt.dataset.startedAt}`);
        if (opt.dataset.endedAt) parts.push(`ended=${opt.dataset.endedAt}`);
        const evs = opt.dataset.events ? `events=${opt.dataset.events}` : '';
        persistMeta.textContent = [parts.join(' · '), evs].filter(Boolean).join(' · ');
      }

      async function loadEvents(jobId) {
        if (!jobId) return;
        try {
          const res = await fetch(`/api/queues/${encodeURIComponent(jobId)}/events?limit=200`);
          if (!res.ok) return;
          const data = await res.json();
          tbody.innerHTML = '';
          const items = Array.isArray(data.items) ? data.items : [];
          for (const it of items) {
            const tr = document.createElement('tr');
            const td = (text) => { const el = document.createElement('td'); el.textContent = text ?? ''; return el; };
            const ts = it.ts ? new Date(it.ts).toLocaleTimeString() : '';
            tr.appendChild(td(ts));
            tr.appendChild(td(it.action||''));
            tr.appendChild(td(it.url||''));
            tr.appendChild(td(it.depth!=null?String(it.depth):''));
            tr.appendChild(td(it.host||''));
            tr.appendChild(td(it.reason||''));
            tr.appendChild(td(it.queueSize!=null?String(it.queueSize):''));
            tr.appendChild(td(jobId));
            tbody.appendChild(tr);
          }
          modeLabel.textContent = 'Persisted queue events';
          historyMode = true;
          const opt = jobSelect.options[jobSelect.selectedIndex];
          renderPersistMeta(opt);
          activeJob = jobId; jobSpan.textContent = activeJob;
        } catch (_) {}
      }

      const evt = new EventSource('/events');
      evt.addEventListener('progress', (e) => {
        // Set active job if exactly one running
        try {
          const p = JSON.parse(e.data);
          if (!activeJob && p && p.jobId) {
            activeJob = p.jobId;
            jobSpan.textContent = activeJob;
          }
        } catch (_) {}
      });
      evt.addEventListener('queue', (e) => {
        try {
          const q = JSON.parse(e.data);
          if (onlyActive.checked && activeJob && q.jobId && q.jobId !== activeJob) return;
          if (!historyMode) {
            ensureHeader();
            addRow(q);
            seen += 1; countEl.textContent = String(seen);
          }
        } catch (_) {}
      });

      loadBtn.addEventListener('click', () => { const id = jobSelect.value; if (id) loadEvents(id); });
      jobSelect.addEventListener('change', () => {
        const opt = jobSelect.options[jobSelect.selectedIndex];
        renderPersistMeta(opt && opt.value ? opt : null);
      });
      loadJobs();
    })();
  </script>
</body>
</html>
