<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>News Crawler UI</title>
  <link rel="stylesheet" href="/crawler.css" />
  <link rel="stylesheet" href="/assets/index.css" />
  <script type="module" src="/assets/global-nav.js"></script>
  </head>
  <body>
    <a class="skip-link" href="#crawl-controls">Skip to crawl controls</a>
    <main class="crawler-layout">
      <header class="page-header">
        <div class="page-header__primary">
          <h1 class="page-title">News Crawler</h1>
          <div class="page-header__nav" data-nav-container>
            <div data-global-nav data-active="crawler" data-variant="bar"></div>
          </div>
        </div>
        <nav class="quick-nav" aria-label="Quick links">
          <ul class="quick-links">
            <li><a href="/urls">URLs</a></li>
            <li><a href="/domain">Domain summary</a></li>
            <li><a href="/domains">Domains</a></li>
            <li><a href="/errors">Errors</a></li>
            <li><a href="/health" target="_blank" rel="noopener">Health</a></li>
            <li><a href="/metrics" target="_blank" rel="noopener">Metrics</a></li>
            <li><a href="/gazetteer">Gazetteer</a></li>
          </ul>
        </nav>
      </header>

      <section id="crawl-controls" class="panel controls-card" aria-labelledby="crawl-controls-heading">
        <header class="controls-card__header">
          <h2 id="crawl-controls-heading" class="section-title">Crawl controls</h2>
          <button id="themeBtn" class="button button--ghost" type="button" title="Toggle dark mode">Dark</button>
        </header>

        <div class="control-grid control-grid--primary">
          <div class="control-field control-field--wide">
            <label for="startUrl">Start URL</label>
            <input id="startUrl" value="https://www.theguardian.com" size="40" />
          </div>
          <div class="control-field">
            <label for="depth">Depth</label>
            <input id="depth" type="number" value="2" />
          </div>
          <div class="control-field">
            <label for="maxPages">Max pages</label>
            <input id="maxPages" type="number" />
          </div>
          <div class="control-field">
            <label for="concurrency">Concurrency</label>
            <input id="concurrency" type="number" value="1" />
          </div>
          <div class="control-field">
            <label for="requestTimeoutMs">Timeout (ms)</label>
            <input id="requestTimeoutMs" type="number" placeholder="10000" />
          </div>
          <div class="control-field">
            <label for="crawlType">Crawl type</label>
            <select id="crawlType">
              <option value="">Loading…</option>
            </select>
          </div>
        </div>

        <details class="controls-advanced" id="controlsAdvanced">
          <summary>Advanced options</summary>
          <div class="control-grid control-grid--advanced">
            <div class="control-field">
              <label for="refetchIfOlderThan">Refetch window (global)</label>
              <input id="refetchIfOlderThan" type="text" placeholder="e.g., 30m or 6h" />
            </div>
            <div class="control-field">
              <label for="refetchArticleIfOlderThan">Refetch window — articles</label>
              <input id="refetchArticleIfOlderThan" type="text" placeholder="e.g., 28d (overrides global)" />
            </div>
            <div class="control-field">
              <label for="refetchHubIfOlderThan">Refetch window — hubs/nav</label>
              <input id="refetchHubIfOlderThan" type="text" placeholder="e.g., 2d (overrides global)" />
            </div>
            <div class="control-field control-field--inline">
              <label for="pacerJitterMinMs">Pacer jitter (ms)</label>
              <div class="control-inline">
                <input id="pacerJitterMinMs" type="number" placeholder="25" />
                <span class="control-inline__dash" aria-hidden="true">–</span>
                <input id="pacerJitterMaxMs" type="number" placeholder="50" />
              </div>
            </div>
            <div class="control-checkboxes">
              <label class="control-checkbox">
                <input id="slowMode" type="checkbox" />
                <span>Slow mode (1 req/s)</span>
              </label>
              <label class="control-checkbox" title="Discover and enqueue URLs from the site’s sitemap in addition to the Start URL. Disable to rely only on link traversal.">
                <input id="useSitemap" type="checkbox" />
                <span>Use sitemap</span>
              </label>
              <label class="control-checkbox">
                <input id="sitemapOnly" type="checkbox" />
                <span>Sitemap only</span>
              </label>
            </div>
          </div>
        </details>

        <div class="control-actions">
          <div class="control-buttons">
            <button id="startBtn" class="button button--primary" type="button">Start</button>
            <button id="stopBtn" class="button" type="button">Stop</button>
            <button id="pauseBtn" class="button" type="button">Pause</button>
            <button id="resumeBtn" class="button" type="button" disabled>Resume</button>
            <button id="analysisBtn" class="button button--secondary" type="button" title="Run offline analysis pipeline">Perform Analysis</button>
          </div>
          <div class="analysis-status-card">
            <span id="analysisLink" class="analysis-link muted"></span>
            <div id="analysisStatus" class="analysis-status muted">
              <div id="analysisStatusSummary" class="analysis-status__summary">No analysis runs yet.</div>
              <ul id="analysisStatusMetrics" class="analysis-status__metrics"></ul>
            </div>
          </div>
        </div>
      </section>
    <section id="overviewSection" class="panel">
      <div class="summary-head">
        <h3>Run overview</h3>
        <div class="summary-meta">
          <span id="crawlTypeBadge" class="badge badge-neutral">Type: unknown</span>
          <span id="stageBadge" class="badge badge-neutral">Stage: idle</span>
          <span id="pausedBadge" class="badge badge-ok" style="display:none;">Running</span>
        </div>
      </div>
      <div class="metrics-grid">
        <div class="metric-card">
          <span class="metric-label">Visited</span>
          <span id="metricVisited" class="metric-value">0</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Downloaded</span>
          <span id="metricDownloaded" class="metric-value">0</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Saved</span>
          <span id="metricSaved" class="metric-value">0</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Found</span>
          <span id="metricFound" class="metric-value">0</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Queue size</span>
          <span id="metricQueue" class="metric-value">0</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Errors</span>
          <span id="metricErrors" class="metric-value">0</span>
        </div>
        <div class="metric-card">
          <span class="metric-label">Coverage</span>
          <span id="metricCoverage" class="metric-value">—</span>
        </div>
      </div>
    </section>
    <section id="insightsPanel" class="panel" data-has-data="0" style="display:none;">
      <div class="summary-head">
        <h3>Intelligent insights</h3>
        <span id="insightsHint" class="muted" style="font-size:12px;">Insights appear once planner telemetry streams in.</span>
      </div>
      <div class="insight-grid">
        <div class="insight-item">
          <span class="insight-label">Coverage achieved</span>
          <span id="insightCoverage" class="insight-value">—</span>
          <span id="insightCoverageDetail" class="insight-detail muted"></span>
        </div>
        <div class="insight-item">
          <span class="insight-label">Seeded hubs</span>
          <span id="insightHubs" class="insight-value">—</span>
          <span id="insightHubsDetail" class="insight-detail muted"></span>
        </div>
        <div class="insight-item">
          <span class="insight-label">Unresolved problems</span>
          <span id="insightProblems" class="insight-value">0</span>
          <span id="insightProblemsDetail" class="insight-detail muted"></span>
        </div>
        <div class="insight-item">
          <span class="insight-label">Planner goals</span>
          <span id="insightGoals" class="insight-value">—</span>
          <span id="insightGoalsDetail" class="insight-detail muted"></span>
        </div>
        <div class="insight-item">
          <span class="insight-label">Queue mix</span>
          <span id="insightQueueMix" class="insight-value">—</span>
          <span id="insightQueueMixDetail" class="insight-detail muted"></span>
        </div>
      </div>
      <div class="insight-extras">
        <div class="insight-extra">
          <h4>Highlights</h4>
          <ul id="insightHighlightsList" class="insight-highlights"></ul>
        </div>
        <div class="insight-extra">
          <h4>Queue heatmap</h4>
          <div id="insightQueueHeatmap" class="insight-heatmap muted">Queue telemetry not yet available.</div>
        </div>
      </div>
    </section>
    <section id="patternInsightsPanel" class="panel pattern-insights" data-has-data="0" style="display:none;">
      <div class="summary-head">
        <h3>Pattern insights</h3>
        <span id="patternInsightsHint" class="muted" style="font-size:12px;">Pattern discovery events appear once the intelligent planner runs.</span>
      </div>
      <div class="pattern-summary-grid">
        <div class="pattern-summary-card">
          <span class="pattern-summary-label">Pattern events</span>
          <span id="patternInsightsTotal" class="pattern-summary-value">0</span>
        </div>
        <div class="pattern-summary-card">
          <span class="pattern-summary-label">Unique sections</span>
          <span id="patternInsightsSections" class="pattern-summary-value">0</span>
        </div>
        <div class="pattern-summary-card">
          <span class="pattern-summary-label">Article hints</span>
          <span id="patternInsightsHints" class="pattern-summary-value">0</span>
        </div>
        <div class="pattern-summary-card pattern-summary-card--wide">
          <span class="pattern-summary-label">Last event</span>
          <span id="patternInsightsLastSummary" class="pattern-summary-value pattern-summary-value--small">No pattern activity yet.</span>
          <span id="patternInsightsLastStage" class="pattern-summary-detail muted">—</span>
          <span class="pattern-summary-detail muted">Updated <span id="patternInsightsLastUpdated">—</span></span>
        </div>
      </div>
      <div class="pattern-insights-grid">
        <div class="pattern-insights-column">
          <h4>Top sections</h4>
          <ul id="patternInsightsTopSections" class="pattern-insights-list"></ul>
        </div>
        <div class="pattern-insights-column">
          <h4>Article hints</h4>
          <ul id="patternInsightsTopHints" class="pattern-insights-list"></ul>
        </div>
        <div class="pattern-insights-column">
          <h4>Homepage fetch sources</h4>
          <ul id="patternInsightsSources" class="pattern-insights-list"></ul>
        </div>
      </div>
      <div class="pattern-log">
        <div class="pattern-log__head">
          <h4>Pattern event log</h4>
        </div>
        <div id="patternInsightsLog" class="pattern-log__list timeline-list muted">No pattern events yet.</div>
      </div>
    </section>
    <section id="pipelinePanel" class="panel pipeline-panel" style="display:none;">
      <div class="summary-head">
        <h3>Intelligent pipeline</h3>
        <span id="pipelineUpdated" class="muted" style="font-size:12px;">Waiting for planner telemetry…</span>
      </div>
      <div id="pipelineDiagram" class="pipeline-diagram muted"></div>
      <div class="pipeline-grid">
        <article class="pipeline-card" data-pipeline-stage="analysis">
          <header class="pipeline-card__head">
            <span id="pipelineAnalysisStatus" class="badge badge-neutral">Idle</span>
            <span id="pipelineAnalysisSummary" class="pipeline-card__summary muted">No analysis runs detected yet.</span>
          </header>
          <dl class="pipeline-card__meta">
            <div>
              <dt>Signals</dt>
              <dd id="pipelineAnalysisSignals" class="muted">None captured</dd>
            </div>
            <div>
              <dt>Last run</dt>
              <dd id="pipelineAnalysisLastRun" class="muted">—</dd>
            </div>
            <div>
              <dt>Detail</dt>
              <dd id="pipelineAnalysisLink" class="muted">—</dd>
            </div>
          </dl>
          <footer id="pipelineAnalysisHistorySection" class="pipeline-card__history">
            <div class="pipeline-history-toolbar">
              <button id="pipelineAnalysisHistoryClear" type="button" class="link-button">Clear history</button>
            </div>
            <ul id="pipelineAnalysisHistory" class="pipeline-history-list"></ul>
          </footer>
        </article>
        <article class="pipeline-card" data-pipeline-stage="planner">
          <header class="pipeline-card__head">
            <span id="pipelinePlannerStatus" class="badge badge-neutral">Idle</span>
            <span id="pipelinePlannerSummary" class="pipeline-card__summary muted">Planner will activate once intelligent crawl begins.</span>
          </header>
          <dl class="pipeline-card__meta">
            <div>
              <dt>Stage</dt>
              <dd id="pipelinePlannerStage" class="muted">—</dd>
            </div>
            <div>
              <dt>Goals</dt>
              <dd id="pipelinePlannerGoals" class="muted">—</dd>
            </div>
          </dl>
        </article>
        <article class="pipeline-card" data-pipeline-stage="execution">
          <header class="pipeline-card__head">
            <span id="pipelineExecutionStatus" class="badge badge-neutral">Idle</span>
            <span id="pipelineExecutionSummary" class="pipeline-card__summary muted">Awaiting crawl activity.</span>
          </header>
          <dl class="pipeline-card__meta">
            <div>
              <dt>Jobs</dt>
              <dd id="pipelineExecutionJobs" class="muted">0</dd>
            </div>
            <div>
              <dt>Queue</dt>
              <dd id="pipelineExecutionQueue" class="muted">—</dd>
            </div>
            <div>
              <dt>Coverage</dt>
              <dd id="pipelineExecutionCoverage" class="muted">—</dd>
            </div>
          </dl>
        </article>
      </div>
      <div id="insightAnalysisHighlights" class="analysis-highlights"></div>
    </section>
    <section id="jobsSection" class="panel panel--compact">
      <div class="panel-head">
        <h3>Ongoing crawls</h3>
        <label class="toggle-control">
          <input type="checkbox" id="showLogs" />
          <span>Show logs</span>
        </label>
      </div>
      <div id="jobsList" class="muted text-sm">None</div>
    </section>

    <section id="progressSection" class="panel panel--stack">
      <div class="panel-head">
        <h3>
          Progress
          <span id="eta" class="muted text-sm"></span>
        </h3>
      </div>
      <div id="progress" class="progress-line">visited: 0, downloaded: 0, found: 0, saved: 0</div>
      <div id="inflight" class="progress-line progress-line--column">
        <span>current downloads: 0</span>
        <ul id="inflightList" class="progress-list"></ul>
      </div>
      <div id="cacheInfo" class="progress-line">cached hits: 0</div>
      <div id="metrics" class="metrics-bar">
        <strong>Metrics:</strong>
        <span id="m_reqps" class="metric-spark">
          <span id="m_reqps_label">req/s: 0</span>
          <svg id="reqps_spark" width="200" height="36" viewBox="0 0 200 36" preserveAspectRatio="none">
            <title id="reqps_title">req/s sparkline</title>
            <polyline id="reqps_poly" class="spark-ok" fill="none" stroke-width="1" points="" />
          </svg>
        </span>
        <span id="m_dlps" class="metric-spark">
          <span id="m_dlps_label">dl/s (≤15s avg): 0 · MB/s (≤15s avg): 0</span>
          <svg id="dlps_spark" width="200" height="36" viewBox="0 0 200 36" preserveAspectRatio="none">
            <title id="dlps_title">dl/s sparkline</title>
            <polyline id="dlps_poly" class="spark-ok" fill="none" stroke-width="1" points="" />
          </svg>
        </span>
        <span id="m_errpm" class="metric-pill">err/min: 0</span>
        <span id="m_qsize" class="metric-spark">
          <span>queue: 0</span>
          <svg id="q_spark" width="200" height="36" viewBox="0 0 200 36" preserveAspectRatio="none">
            <title id="q_title">queue sparkline</title>
            <polyline id="q_poly" class="spark-ok" fill="none" stroke-width="1" points="" />
          </svg>
        </span>
        <span id="m_domrpm" class="metric-pill muted" style="display:none;">domain rpm: n/a</span>
        <span id="m_domlim" class="metric-pill muted" style="display:none;">limit: n/a</span>
        <span id="m_dombk" class="metric-pill muted" style="display:none;">backoff: -</span>
        <span id="m_domrl" class="metric-pill bad" style="display:none; font-weight:bold;">RATE LIMITED</span>
        <span id="m_errs" class="metric-pill">errors: 0</span>
        <span id="cacheGauge" class="metric-pill muted">cache: 1m 0% · 5m 0%</span>
      </div>
    </section>

    <section id="eventsSection" class="panel panel--expando">
      <details id="secErrors" open>
        <summary><strong>Recent errors</strong></summary>
        <div id="errorsPanel" class="expando-body text-sm">
          <div id="errorsList" class="muted">Loading…</div>
        </div>
      </details>
      <details id="secProblems" open>
        <summary><strong>Problems (expectations)</strong></summary>
        <div id="problemsPanel" class="expando-body text-sm">
          <div id="problemsList" class="muted">None</div>
        </div>
      </details>
      <details id="secMilestones" open>
        <summary><strong>Milestones</strong></summary>
        <div id="milestonesList" class="timeline-list muted">No milestones yet.</div>
      </details>
      <details id="secPlanner" open>
        <summary><strong>Planner timeline</strong></summary>
        <div id="plannerStagesList" class="timeline-list muted">Planner telemetry appears when intelligent crawls run.</div>
      </details>
      <details id="secDomains" open>
        <summary><strong>Recent Domains</strong></summary>
        <div id="domains" class="meta text-sm">Loading…</div>
      </details>
      <details id="secLogs" open>
        <summary><strong>Logs</strong></summary>
        <div class="logs-body">
          <div id="logsToolbar" class="logs-toolbar">
            <span>font:</span>
            <button id="logsFontMinus" type="button" class="button button--ghost button--xs" title="Smaller">A-</button>
            <button id="logsFontPlus" type="button" class="button button--ghost button--xs" title="Larger">A+</button>
            <span id="logsFontVal" class="muted"></span>
          </div>
          <pre id="logs"></pre>
          <div id="logsResizer" class="resizer-h" title="Drag to resize logs"></div>
        </div>
      </details>
    </section>

    <section id="healthPanel" class="panel panel--compact">
      <div class="panel-head">
        <h3>Status</h3>
      </div>
      <div id="healthStrip" class="health-strip">
        <span id="badgeRobots" class="muted">robots: …</span>
        <span id="badgeSitemap" class="muted">sitemap: 0 / 0</span>
        <span id="badgeDb" class="muted">db: …</span>
        <span id="badgeDisk" class="muted">disk: …</span>
        <span id="badgeConn" class="badge badge-warn">SSE: connecting…</span>
      </div>
      <div class="panel-footer-link">
        <a href="/urls">View saved article URLs</a>
      </div>
    </section>
    </main>
    <script type="module" src="/assets/index.js"></script>
  </body>
  </html>
