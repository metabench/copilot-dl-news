<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Domain Summary</title>
  <link rel="stylesheet" href="/ui.css" />
  <link rel="stylesheet" href="/ui-dark.css" />
    <script type="module" src="/assets/theme/init.js"></script>
    <script type="module" src="/assets/global-nav.js"></script>
  </head>
  <body class="ui-page domain-summary-page">
    <div data-global-nav data-active="domains" data-variant="bar"></div>
    <main class="ui-container domain-summary">
      <header class="ui-header">
        <h1 class="ui-header__title">Domain Summary</h1>
      </header>

      <section class="domain-summary__controls u-flex u-flex-wrap u-gap-sm u-items-end">
        <div class="domain-summary__control">
          <label class="domain-summary__label" for="host">Domain or host</label>
          <input id="host" class="domain-summary__input" placeholder="example.com" />
        </div>
        <div class="domain-summary__control domain-summary__control--checkbox">
          <label class="domain-summary__checkbox">
            <input id="subs" type="checkbox" />
            <span>Include subdomains</span>
          </label>
        </div>
        <div class="domain-summary__actions u-flex u-gap-sm">
          <button id="load" class="ui-button">Load</button>
          <a href="/" class="ui-button ui-button--secondary">Home</a>
          <button id="analyze" class="ui-button ui-button--secondary">Analyze now</button>
        </div>
      </section>

      <section id="summary" class="domain-summary__status text-muted">Enter a host and click Load.</section>

      <section id="domAnalysis" class="domain-summary__analysis"></section>

      <section class="domain-summary__section">
        <h3 class="domain-summary__section-title">Recent Articles</h3>
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Section</th>
              <th>Date</th>
              <th>Saved at</th>
              <th>URL</th>
            </tr>
          </thead>
          <tbody id="arts"></tbody>
        </table>
      </section>

      <section class="domain-summary__section">
        <h3 class="domain-summary__section-title">Fetch Classification</h3>
        <table>
          <thead>
            <tr>
              <th>Classification</th>
              <th>Count</th>
            </tr>
          </thead>
          <tbody id="classTbl"></tbody>
        </table>
      </section>

      <section class="domain-summary__section">
        <h3 class="domain-summary__section-title">Top Content Types</h3>
        <table>
          <thead>
            <tr>
              <th>Type</th>
              <th>Count</th>
            </tr>
          </thead>
          <tbody id="ctTbl"></tbody>
        </table>
      </section>
    </main>

    <script>
      function fmt(v){ return v==null? '' : String(v); }
      function fmtBytes(n){ if(n==null) return ''; const k=1024; const sizes=['B','KB','MB','GB']; let i=0; let x=n; while(x>=k && i<sizes.length-1){ x/=k; i++; } return `${x.toFixed(1)} ${sizes[i]}`; }
      function esc(s){ return String(s).replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
      function renderJson(data){
        if(!data) return '<div class="domain-summary__placeholder text-muted">No domain analysis.</div>';
        try { const o = typeof data==='string'? JSON.parse(data) : data; return `<pre class="domain-summary__analysis-pre">${esc(JSON.stringify(o,null,2))}</pre>`; } catch {
          return `<pre class="domain-summary__analysis-pre">${esc(data)}</pre>`;
        }
      }
      async function load(){
        const host = document.getElementById('host').value.trim();
        const subs = document.getElementById('subs').checked ? '1' : '0';
        if(!host){ document.getElementById('summary').textContent = 'Please enter a host.'; return; }
        const r = await fetch(`/api/domain-summary?host=${encodeURIComponent(host)}&subdomains=${subs}`);
        const j = await r.json();
        if(!r.ok){ document.getElementById('summary').textContent = 'Error: ' + (j.error||r.statusText); return; }
  const a = j.articles || {}; const f = j.fetches || {};
        const stats = [
          `articles: ${a.total_articles||0}`,
          `last saved: ${fmt(a.last_saved_at)}`,
          `fetches: ${f.total_fetches||0}`,
          `ok: ${f.ok_count||0}`,
          `errors: ${f.err_count||0}`,
          `bytes: ${fmtBytes(f.total_bytes||0)}`,
          `avg total ms: ${Math.round(f.avg_total_ms||0)}`,
          `last fetch: ${fmt(f.last_fetch_at)}`
        ];
        document.getElementById('summary').innerHTML = stats.map(s=>`<span class="domain-summary__stat">${s}</span>`).join(' ');

  const domDiv = document.getElementById('domAnalysis');
  const categories = (j.domainCategories||[]).map(c=>`<span class="domain-summary__tag">category: ${esc(c)}</span>`).join(' ');
  const header = `<div class="domain-summary__categories">${categories || '<span class="text-muted">No categories</span>'}</div>`;
  const analysis = renderJson(j.domain?.analysis || null);
  domDiv.innerHTML = `<h3 class="domain-summary__section-title">Domain analysis</h3>${header}${analysis}`;
        const tb = document.getElementById('arts');
        tb.innerHTML = '';
        (j.recentArticles||[]).forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmt(r.title)}</td>
            <td>${fmt(r.section)}</td>
            <td>${fmt(r.date)}</td>
            <td>${fmt(r.ts)}</td>
            <td class="domain-summary__wrap"><a href="/url?u=${encodeURIComponent(r.url)}" target="_blank">${r.url}</a></td>
          `;
          tb.appendChild(tr);
        });
        const ct = document.getElementById('ctTbl');
        ct.innerHTML = '';
        (j.topContentTypes||[]).forEach(x => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${fmt(x.type)}</td><td>${fmt(x.c)}</td>`;
          ct.appendChild(tr);
        });
        const cl = document.getElementById('classTbl');
        cl.innerHTML = '';
        (j.classification||[]).forEach(x => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${fmt(x.classification)}</td><td>${fmt(x.c)}</td>`;
          cl.appendChild(tr);
        });
      }
      document.getElementById('load').onclick = load;
      document.getElementById('analyze').onclick = async () => {
        const host = document.getElementById('host').value.trim();
        if(!host) return;
        const r = await fetch('/api/analyze-domain', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ host }) });
        const j = await r.json();
        if(!r.ok){ alert('Analyze failed: ' + (j.error||r.statusText)); return; }
        // Refresh view
        load().catch(()=>{});
      };
      // Prefill from URL
      (function(){
        const u = new URL(location.href);
        const h = u.searchParams.get('host') || u.searchParams.get('domain');
        const s = u.searchParams.get('subdomains') || u.searchParams.get('includeSubdomains');
        if(h){ document.getElementById('host').value = h; }
        if(s){ document.getElementById('subs').checked = s === '1'; }
        if(h){ load().catch(()=>{}); }
      })();
    </script>
  </body>
</html>
