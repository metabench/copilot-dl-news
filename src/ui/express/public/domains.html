<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>News Domains</title>
  <link rel="stylesheet" href="/ui.css"/>
  <link rel="stylesheet" href="/ui-dark.css"/>
    <script type="module" src="/assets/theme/init.js"></script>
    <script type="module" src="/assets/global-nav.js"></script>
  </head>
  <body class="ui-page domains-page">
  <div data-global-nav data-active="domains" data-variant="bar"></div>
    <main class="ui-container domains-layout">
      <header class="ui-header">
        <h1 class="ui-header__title">News Domains</h1>
      </header>
      <p class="text-muted domains-intro">Alphabetical list of news websites known to the system. Click a domain to view its summary.</p>
      <div class="domains-grid">
        <aside class="domains-sidebar">
          <input id="q" class="domains-search" type="text" placeholder="Filter domains…" />
          <div id="list" class="domains-list">Loading…</div>
        </aside>
        <section class="domains-content">
          <div id="details" class="domains-placeholder text-muted">Select a domain to view details.</div>
        </section>
      </div>
    </main>
    <script>
      const listEl = document.getElementById('list');
      const qEl = document.getElementById('q');
      const detailsEl = document.getElementById('details');
      let DOMAINS = [];
      let ACTIVE = null;

      function renderList(filter) {
        const q = (filter || '').toLowerCase().trim();
        const items = DOMAINS.filter(d => !q || d.host.includes(q));
        if (!items.length) { listEl.textContent = 'No domains.'; return; }
        const frag = document.createDocumentFragment();
        for (const d of items) {
          const div = document.createElement('div');
          div.className = 'domains-list__item' + (ACTIVE === d.host ? ' domains-list__item--active' : '');
          div.textContent = d.host;
          div.onclick = () => selectDomain(d.host);
          frag.appendChild(div);
        }
        listEl.innerHTML = '';
        listEl.appendChild(frag);
      }

      async function selectDomain(host) {
        ACTIVE = host;
        renderList(qEl.value);
        detailsEl.textContent = 'Loading…';
        try {
            const includeSub = '0';
            const r = await fetch(`/api/domain-summary?host=${encodeURIComponent(host)}&includeSubdomains=${includeSub}`);
            if (!r.ok) { detailsEl.textContent = `Failed to load summary for ${host} (HTTP ${r.status})`; return; }
            const j = await r.json();
            detailsEl.innerHTML = `
              <h2 class="domains-details__title">${host}</h2>
              <div class="domains-details__meta">
                <span class="text-muted">articles:</span> ${j.articles?.total_articles ?? 0}
                · <span class="text-muted">last saved:</span> ${j.articles?.last_saved_at ?? 'n/a'}
                · <span class="text-muted">last fetch:</span> ${j.fetches?.last_fetch_at ?? 'n/a'}
                · <span class="text-muted">ok/err:</span> ${(j.fetches?.ok_count ?? 0)} / ${(j.fetches?.err_count ?? 0)}
              </div>
              <div>${renderAnalysis(j)}</div>
              ${render429(j)}
              ${renderPlaceHubs(j)}
              <div class="domains-details__link"><a href="/urls?host=${encodeURIComponent(host)}&details=1" target="_blank" rel="noopener">Open URLs for this domain →</a></div>
              <h3 class="domains-details__heading">Recent articles</h3>
              <ul class="domains-details__list">
                ${(j.recentArticles || []).map(a => `<li class="domains-details__item"><a href="/url?url=${encodeURIComponent(a.url)}">${a.title || a.url}</a> <span class="text-muted">(${a.ts || ''})</span></li>`).join('') || '<li class="domains-details__item domains-details__item--empty text-muted">None</li>'}
              </ul>
            `;
        } catch (e) {
          detailsEl.textContent = `Failed to load summary for ${host}`;
        }
      }

      async function init() {
        try {
          const r = await fetch('/api/news-domains');
          if (!r.ok) { listEl.textContent = 'Failed to load'; return; }
          const j = await r.json();
          DOMAINS = (j.domains || []).map(x => ({ host: String(x.host).toLowerCase() }));
          renderList('');
          if (DOMAINS.length) selectDomain(DOMAINS[0].host);
        } catch (_) {
          listEl.textContent = 'Failed to load';
        }
      }

      qEl.addEventListener('input', () => renderList(qEl.value));
      init();

      function renderAnalysis(j) {
        try {
          const a = j.analysis || null;
          const m = j.analysisMetrics || null;
          if (!a) return '';
          const pct = (a.score != null) ? (a.score * 100).toFixed(0) + '%' : 'n/a';
          const ev = a.evidence || {};
          const evStr = [
            ev.articleFetches != null ? `articles=${ev.articleFetches}` : null,
            ev.distinctSections != null ? `sections=${ev.distinctSections}` : null,
            ev.datedUrlRatio != null ? `dated_ratio=${(ev.datedUrlRatio*100).toFixed(0)}%` : null
          ].filter(Boolean).join(' · ');
          return `<div class=\"domains-details__analysis\"><span class=\"text-muted\">analysis:</span> ${a.kind || 'n/a'} · score ${pct}${evStr ? ' · ' + evStr : ''}</div>`;
        } catch (_) { return ''; }
      }

      function render429(j) {
        try {
          const r = j.rate429;
          if (!r || !r.samples) return '';
          const fmt = (n, d=0) => (n==null?'-':Number(n).toFixed(d));
          return `<div class=\"domains-details__rate\"><span class=\"text-muted\">429-trigger rates:</span> avg ${fmt(r.avgReqPerMin,1)} req/min · p95 ${fmt(r.p95ReqPerMin,1)} req/min · avg ${fmt(r.avgKBps,1)} KB/s · p95 ${fmt(r.p95KBps,1)} KB/s <span class=\"text-muted\">(n=${r.samples})</span></div>`;
        } catch (_) { return ''; }
      }

      function renderPlaceHubs(j) {
        try {
          const p = j.placeHub;
          if (!p || !Array.isArray(p.topPatterns) || p.topPatterns.length === 0) return '';
          const items = p.topPatterns.map(g => `<li class=\"domains-details__hubs-item\"><code>${g.key}</code> — pages: ${g.urls}, max nav links: ${g.maxNav}${(g.examples && g.examples.length) ? ` <span class=\"text-muted\">e.g.</span> <a href=\"/url?url=${encodeURIComponent(g.examples[0])}\">${g.examples[0]}</a>` : ''}</li>`).join('');
          return `<div class=\"domains-details__hubs\"><span class=\"text-muted\">place hubs:</span> total candidates ${p.totalCandidates}. <ul class=\"domains-details__hubs-list\">${items}</ul></div>`;
        } catch (_) { return ''; }
      }
    </script>
  </body>
</html>
