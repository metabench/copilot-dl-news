<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>URL Details</title>
  <link rel="stylesheet" href="/crawler.css" />
  <link rel="stylesheet" href="/ui-dark.css" />
     <script type="module" src="/assets/theme/init.js"></script>
     <script type="module" src="/assets/global-nav.js"></script>
  </head>
  <body class="legacy-page legacy-page--url">
  <div data-global-nav data-active="urls" data-variant="bar"></div>
    <h1>URL Details</h1>
    <div id="hdr" class="muted">Loading…</div>
  <div id="badges" class="badges is-hidden"></div>
  <div class="muted hint-legend text-sm" id="hintLegend">
      <span>Hint legend:</span>
      <span class="badge badge-article">Article</span>
      <span class="badge badge-nav">Nav/Hub</span>
      <span class="badge badge-other">Other</span>
      <span>Confidence = certainty (0–100%)</span>
    </div>
  <div id="urlAnalysis" class="legacy-section"></div>
  <div id="article"></div>
    <h3 class="legacy-subheading">Downloads</h3>
    <div id="diffWrap" class="diff-wrap is-hidden">
      <button id="showDiff" class="btn">Compare latest vs previous</button>
      <div id="diffPanel" class="diff-panel is-hidden"></div>
    </div>
    <table id="tbl">
      <thead>
        <tr>
          <th class="nowrap">Fetched at</th>
          <th>Status</th>
          <th>Type</th>
          <th>Encoded</th>
          <th>Encoding</th>
          <th>Bytes</th>
          <th>On disk</th>
          <th>TTFB</th>
          <th>DL ms</th>
          <th>Total ms</th>
          <th>Class</th>
          <th>Nav links</th>
          <th>Article links</th>
          <th>Words</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <script>
      function fmt(v){ return v==null? '' : String(v); }
      function fmtBytes(n){ if(n==null) return ''; const k=1024; const sizes=['B','KB','MB','GB']; let i=0; let x=n; while(x>=k && i<sizes.length-1){ x/=k; i++; } return `${x.toFixed(1)} ${sizes[i]}`; }
      function qs(name){ const u = new URL(location.href); return u.searchParams.get(name) || ''; }
      function classificationBadge(cls){
        const span = document.createElement('span');
        span.className = `badge badge-${cls}`;
        span.textContent = cls;
        return span;
      }
      function hintBadge(hint, confidence){
        const span = document.createElement('span');
        const cls = (hint==='article')?'badge-article': (hint==='nav')?'badge-nav':'badge-other';
        span.className = `badge ${cls}`;
        const pct = (typeof confidence==='number') ? ` ${(confidence*100).toFixed(0)}%` : '';
        span.textContent = `hint: ${hint}${pct}`;
        return span;
      }
      function tryParse(obj){
        if (!obj) return null; if (typeof obj === 'object') return obj;
        try { return JSON.parse(obj); } catch { return null; }
      }
      function renderJsonPreview(data){
        if(!data) return '';
        try {
          const obj = typeof data === 'string' ? JSON.parse(data) : data;
          const s = JSON.stringify(obj, null, 2);
          return `<pre class="legacy-pre">${s.replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]))}</pre>`;
        } catch {
          const s = String(data);
          return `<pre class="legacy-pre">${s.replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]))}</pre>`;
        }
      }

      async function load(){
        const url = qs('u') || qs('url');
        if(!url){ document.getElementById('hdr').textContent = 'Missing url parameter'; return; }
        document.getElementById('hdr').innerHTML = `<a href="/urls">All URLs</a> · <code>${url}</code>`;
        const r = await fetch(`/api/url-details?u=${encodeURIComponent(url)}`);
        const j = await r.json();
        if(!r.ok){ document.getElementById('hdr').textContent = 'Error: ' + (j.error||r.statusText); return; }
        const urlDiv = document.getElementById('urlAnalysis');
        if(j.urlInfo){
          const u = j.urlInfo;
          const meta = `<div class="muted">first seen: ${fmt(u.created_at)} · last seen: ${fmt(u.last_seen_at)}</div>`;
          const body = u.analysis ? renderJsonPreview(u.analysis) : '<div class="muted">No URL analysis.</div>';
          urlDiv.innerHTML = `<h3 class="legacy-subheading legacy-subheading--tight">URL analysis</h3>${meta}${body}`;
        } else {
          urlDiv.innerHTML = '';
        }

        const aDiv = document.getElementById('article');
        if(j.article){
          const a = j.article;
          const xp = a.article_xpath ? `<div class="muted u-mt-xs">XPath: <code>${a.article_xpath}</code></div>` : '';
          const analysisBlock = a.analysis ? `<div class="u-mt-sm"><div class="muted">Article analysis:</div>${renderJsonPreview(a.analysis)}</div>` : '';
          aDiv.innerHTML = `<div class="legacy-article-meta"><strong>Article:</strong> <span>${fmt(a.title)}</span> · <span class="muted">section: ${fmt(a.section)}</span> · <span class="muted">date: ${fmt(a.date)}</span></div>${xp}${analysisBlock}`;
            if (a.article_xpath) {
              const xp = `<div class="xp-wrap"><span class="muted">XPath:</span> <code id="xp" class="xp-code">${a.article_xpath}</code> <button class="btn" id="copy">Copy</button></div>`;
              aDiv.innerHTML = `<div class="legacy-article-meta"><strong>Article:</strong> <span>${fmt(a.title)}</span> · <span class="muted">section: ${fmt(a.section)}</span> · <span class="muted">date: ${fmt(a.date)}</span></div>${xp}`;
              const btn = document.getElementById('copy');
              btn.addEventListener('click', async () => {
                const txt = document.getElementById('xp').textContent;
                try { await navigator.clipboard.writeText(txt); btn.textContent = 'Copied'; setTimeout(()=>btn.textContent='Copy', 1200); } catch {}
              });
            }
        } else {
          aDiv.innerHTML = `<div class="muted">No article record found.</div>`;
        }
        // Badges from most recent fetch
        const badges = document.getElementById('badges');
        badges.innerHTML = '';
        const latest = (j.fetches && j.fetches.length) ? j.fetches[0] : null;
        if(latest){
          badges.classList.remove('is-hidden');
          const cls = latest.classification || 'other';
          badges.appendChild(classificationBadge(cls));
          const enc = latest.content_encoding ? `${latest.content_encoding}` : 'none';
          const encSpan = document.createElement('span');
          encSpan.className = 'badge badge-enc';
          encSpan.textContent = `encoding: ${enc}`;
          badges.appendChild(encSpan);
          if(latest.word_count != null){
            const wc = document.createElement('span');
            wc.className = 'badge';
            wc.textContent = `words: ${latest.word_count}`;
            badges.appendChild(wc);
          }
          // Show combined hint/confidence from article or latest fetch analysis
          let combined = null;
          const artCombined = tryParse(j.article?.analysis)?.combined;
          const fetchCombined = tryParse(latest.analysis)?.combined;
          combined = artCombined || fetchCombined || null;
          if (combined && combined.hint) {
            badges.appendChild(hintBadge(combined.hint, combined.confidence));
          }
        } else {
          badges.classList.add('is-hidden');
        }
  const tb = document.querySelector('#tbl tbody');
        tb.innerHTML = '';
  (j.fetches||[]).forEach(f => {
          const tr = document.createElement('tr');
          const enc = f.content_encoding ? 'yes' : 'no';
          const disk = f.file_size != null ? fmtBytes(f.file_size) : '';
          // Inline hint from analysis if available
          let inlineHint = '';
          try {
            const an = tryParse(f.analysis);
            if (an && an.combined && an.combined.hint) {
              const pct = (typeof an.combined.confidence==='number') ? ` ${(an.combined.confidence*100).toFixed(0)}%` : '';
              inlineHint = ` • ${an.combined.hint}${pct}`;
            } else if (an) {
              inlineHint = ' • analysis';
            }
          } catch {}
          tr.innerHTML = `
            <td class="nowrap">${fmt(f.fetched_at)}</td>
            <td>${fmt(f.http_status)}</td>
            <td>${fmt(f.content_type)}</td>
            <td>${enc}</td>
            <td>${fmt(f.content_encoding)}</td>
            <td>${fmtBytes(f.bytes_downloaded ?? f.content_length)}</td>
            <td>${disk}</td>
            <td>${fmt(f.ttfb_ms)}</td>
            <td>${fmt(f.download_ms)}</td>
            <td>${fmt(f.total_ms)}</td>
            <td>${fmt(f.classification)}</td>
            <td>${fmt(f.nav_links_count)}</td>
            <td>${fmt(f.article_links_count)}</td>
            <td>${fmt(f.word_count)}${inlineHint}</td>
          `;
          tb.appendChild(tr);
          if (f.analysis) {
            const tr2 = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 14;
            td.innerHTML = renderJsonPreview(f.analysis);
            tr2.appendChild(td);
            tb.appendChild(tr2);
          }
        });

        // Enable diff if we have at least two fetches
        if ((j.fetches||[]).length >= 2) {
          const latest = j.fetches[0];
          const prev = j.fetches[1];
          const wrap = document.getElementById('diffWrap');
          const btn = document.getElementById('showDiff');
          const panel = document.getElementById('diffPanel');
            wrap.classList.remove('is-hidden');
          btn.onclick = async () => {
              if (panel.classList.contains('is-hidden')) {
              panel.textContent = 'Loading…';
                panel.classList.remove('is-hidden');
              try {
                const [a, b] = await Promise.all([
                  fetch(`/api/fetch-body?id=${latest.id}`),
                  fetch(`/api/fetch-body?id=${prev.id}`)
                ]);
                const at = a.ok ? await a.text() : '';
                const bt = b.ok ? await b.text() : '';
                panel.innerHTML = renderSideBySideDiff(bt, at);
              } catch (e) {
                panel.textContent = 'Failed to load diff: ' + e.message;
              }
            } else {
              panel.classList.add('is-hidden');
            }
          };
        }
      }

      function renderSideBySideDiff(oldText, newText) {
        // Very basic line diff
        const oldLines = String(oldText || '').split(/\r?\n/);
        const newLines = String(newText || '').split(/\r?\n/);
        const max = Math.max(oldLines.length, newLines.length);
        const rows = [];
        for (let i = 0; i < max; i++) {
          const a = oldLines[i] ?? '';
          const b = newLines[i] ?? '';
          const changed = a !== b;
          const oldClass = `diff-cell diff-cell--old${changed ? ' diff-cell--changed' : ''}`;
          const newClass = `diff-cell diff-cell--new${changed ? ' diff-cell--changed' : ''}`;
          rows.push(`<tr>
            <td class="${oldClass}"><pre class="diff-pre">${escapeHtml(a)}</pre></td>
            <td class="${newClass}"><pre class="diff-pre">${escapeHtml(b)}</pre></td>
          </tr>`);
        }
        return `<table class="diff-table"><tbody>${rows.join('')}</tbody></table>`;
      }
      function escapeHtml(s){ return String(s).replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
      load().catch(e => {
        document.getElementById('hdr').textContent = 'Failed to load: ' + e.message;
      });
    </script>
  </body>
</html>
